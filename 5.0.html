<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PropertyWize Decision Tool â€” Clean Build</title>

<!-- ===== Minimal, neutral styles (keeps your familiar layout/feel) ===== -->
<style>
  :root{
    --bg:#f7f7fb;
    --card:#ffffff;
    --ink:#1f2430;
    --muted:#6b7280;
    --accent:#1f7ae0;
    --hr:#e5e7eb;
    --kbd:#eef2f7;
    --border:#e6e6ef;
    --radius:10px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px;}
  header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px}
  header .brand{font-weight:700;font-size:18px;margin-right:auto}
  header .nav a{display:inline-block;padding:8px 10px;border-radius:8px;text-decoration:none;color:var(--ink);background:#fff;border:1px solid var(--border);margin-right:6px}
  header .nav a:hover{border-color:var(--accent)}
  .badge{display:inline-block;background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:2px 6px 8px 0;color:var(--muted)}
  .hr{height:1px;background:var(--hr);margin:14px 0}
  .view-pane{display:block}
  .hidden{display:none !important}
  h3{margin:0 0 10px 0}
  .note{color:var(--muted);font-size:12.5px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
  .row{display:flex;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .soft{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
  label{display:block;font-size:12px;color:var(--muted);margin:4px 0}
  input[type="text"],input[type="number"],input[type="date"],input[type="url"],select,textarea{
    width:100%;box-sizing:border-box;border:1px solid var(--border);border-radius:8px;background:#fff;padding:8px 10px;font:inherit;
  }
  textarea{min-height:110px}
  .kbd{background:var(--kbd);padding:2px 6px;border-radius:6px;border:1px solid var(--border)}
  details{border:1px solid var(--border);border-radius:8px;padding:10px;background:#fff;margin:10px 0}
  details summary{cursor:pointer;font-weight:600}
  .check{display:flex;align-items:center;gap:10px;margin:6px 0}
  .check input{transform:translateY(1px)}
  /* Make Water Bills block span full width on wide screens */
  @media (min-width:1100px){
    #viewFinance #waterbills{grid-column:1 / -1;width:100%}
  }
  @media (max-width:800px){ .two-col{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">PropertyWize Decision Tool</div>
    <nav class="nav">
      <a href="#" data-target="viewMaintenance">Maintenance</a>
      <a href="#" data-target="viewFinance">Finance</a>
      <a href="#" data-target="viewListings">Stale Listing</a>
      <a href="#" data-target="viewDelinquency">Delinquency</a>
      <a href="#" data-target="viewNonMaint">Non-Maintenance Bill</a>
    </nav>
  </header>

  <!-- =========================================================
       MAINTENANCE
  ========================================================== -->
  <div id="viewMaintenance" class="view-pane">
    <div class="badge">Owner FYI for emergencies is sent by <b>Maintenance</b></div>
    <div class="badge">Handoff status: <span class="kbd">READY FOR FINANCE</span></div>
    <div class="hr"></div>

    <!-- Maintenance Dispatch Flow -->
    <div class="card" id="maintDispatchFlow" style="margin-bottom:12px;">
      <h3>Maintenance Dispatch Flow</h3>
      <p class="note">Answer each question in order. The next step will appear automatically.</p>

      <!-- Q1 -->
      <div class="flowQ" id="q1">
        <label><strong>Is it an Emergency?</strong></label>
        <div class="row" style="gap:8px;">
          <button type="button" class="btn" data-next="OUT_EMER">Yes</button>
          <button type="button" class="btn" data-next="q2">No</button>
        </div>
      </div>

      <!-- Q2 -->
      <div class="flowQ hidden" id="q2">
        <label><strong>Is the Property in Delinquent Status?</strong></label>
        <div class="row" style="gap:8px;">
          <button type="button" class="btn" data-next="OUT_DELINQ">Yes</button>
          <button type="button" class="btn" data-next="q3">No</button>
        </div>
      </div>

      <!-- Q3 -->
      <div class="flowQ hidden" id="q3">
        <label><strong>Is the Property enrolled in a Home Warranty program?</strong></label>
        <div class="row" style="gap:8px;">
          <button type="button" class="btn" data-next="OUT_HW">Yes</button>
          <button type="button" class="btn" data-next="q4">No</button>
        </div>
      </div>

      <!-- Q4 -->
      <div class="flowQ hidden" id="q4">
        <label><strong>Will the Owner complete their own maintenance tickets?</strong></label>
        <div class="row" style="gap:8px;">
          <button type="button" class="btn" data-next="OUT_NOTIFY_OWNER">Yes</button>
          <button type="button" class="btn" data-next="q5">No</button>
        </div>
      </div>

      <!-- Q5 -->
      <div class="flowQ hidden" id="q5">
        <label><strong>Was the same issue reported within the last 12 months?</strong></label>
        <div class="row" style="gap:8px;">
          <button type="button" class="btn" data-next="OUT_RECALL">Yes</button>
          <button type="button" class="btn" data-next="OUT_STANDARD">No</button>
        </div>
      </div>

      <!-- Outcome -->
      <div id="mdf_out_wrap" class="hidden" style="margin-top:10px;">
        <div class="hr"></div>
        <label><strong>Decision</strong></label>
        <textarea id="mdf_out" readonly style="min-height:110px"></textarea>
        <div class="row" style="gap:8px;margin-top:6px;">
          <button type="button" class="btn primary" id="mdf_copy">Copy Decision</button>
          <button type="button" class="btn" id="mdf_reset">Reset</button>
        </div>
      </div>

      <!-- Emergency Email (only shows when Emergency is chosen) -->
      <div id="emerg_email_wrap" class="hidden" style="margin-top:12px;">
        <div class="hr"></div>
        <h3>Emergency Email Data</h3>

        <div class="two-col">
          <div class="field">
            <label>Tenant Name</label>
            <input id="maint_tenant" type="text" placeholder="e.g., Jane Smith">
          </div>
          <div class="field">
            <label>Unit Address</label>
            <input id="maint_address" type="text" placeholder="e.g., 123 Main St, Baltimore MD">
          </div>
        </div>

        <div class="two-col">
          <div class="field">
            <label>Owner Name (for greeting)</label>
            <input id="maint_owner_name" type="text" placeholder="e.g., John Doe">
          </div>
          <div class="field">
            <label>Vendor Visit Date</label>
            <input id="maint_vendor_visitdate" type="date">
          </div>
        </div>

        <div class="field">
          <label>Tenant Complaint (quote exact)</label>
          <textarea id="maint_tenant_complaint" rows="3" placeholder="Quote tenantâ€™s original statementâ€¦"></textarea>
        </div>

        <div class="two-col">
          <div class="field">
            <label>Vendor Findings (diagnosis)</label>
            <textarea id="maint_vendor_findings" rows="3" placeholder="What the vendor foundâ€¦"></textarea>
          </div>
          <div class="field">
            <label>Vendor Recommendation (proposed work)</label>
            <textarea id="maint_vendor_reco" rows="3" placeholder="What the vendor recommendsâ€¦"></textarea>
          </div>
        </div>

        <div class="two-col">
          <div class="field">
            <label>Vendor Estimate (USD)</label>
            <input id="maint_vendor_estimate" type="number" step="0.01" min="0" placeholder="e.g., 325.00">
          </div>
          <div class="field">
            <label>Portal Link (optional)</label>
            <input id="maint_portal_link" type="url" placeholder="https://â€¦">
          </div>
        </div>

        <div class="row" style="gap:8px; margin-top:6px;">
          <button type="button" class="btn primary" id="med_generate">Generate Emergency Emails</button>
        </div>

        <div class="hr"></div>
        <h3>Emergency Emails (auto-filled)</h3>
        <p class="note"><strong>Policy:</strong> Step 1: FYI to <em>EPM</em> for approval. Step 2: After EPM approves, FYI to <em>Owner</em>.</p>

        <div class="field">
          <label>EPM Subject</label>
          <input id="epm_subj" type="text" readonly>
        </div>
        <div class="field">
          <label>EPM Body</label>
          <textarea id="epm_body" rows="9" readonly></textarea>
          <div class="row" style="justify-content:flex-end; gap:8px;">
            <button type="button" class="btn" data-copy="#epm_body">Copy EPM Email</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="field">
          <label>Owner Subject</label>
          <input id="own_subj" type="text" readonly>
        </div>
        <div class="field">
          <label>Owner FYI Body</label>
          <textarea id="own_body" rows="11" readonly></textarea>
          <div class="row" style="justify-content:flex-end; gap:8px;">
            <button type="button" class="btn" data-copy="#own_body">Copy Owner Email</button>
          </div>
        </div>
      </div>
    </div>

    <!-- WO + Controls (unchanged look; plan + issue) -->
    <div class="two-col">
      <div class="soft">
        <h3>WO Details</h3>
        <div class="field"><label class="small">Work Order #</label><input id="wo" type="text" placeholder="e.g., 3425886"></div>
        <div class="field"><label class="small">Property Address</label><input id="addr" type="text" placeholder="e.g., 7418 Hindon Cir"></div>
        <div class="field"><label class="small">Vendor</label><input id="vendor" type="text" placeholder="e.g., ABC Plumbing"></div>
        <div class="field">
          <label class="small">Owner Plan</label>
          <select id="plan">
            <option value="">Selectâ€¦</option>
            <option>Standard (Owner Approval &gt; 300+)</option>
            <option>Home Warranty (Owner Has An Active HW Plan with PW Auth)</option>
            <option>Basic (Owner Approval &gt; 150+)</option>
            <option>Opt-Out (Owner Managed)</option>
            <option>Emergency-Only (Auto Approved, EPM Approved, FYI to Owner)</option>
          </select>
        </div>
        <div class="field">
          <label class="small">Issue Type</label>
          <select id="issue">
            <option value="">Selectâ€¦</option>
            <option>Emergency</option>
            <option>Non-Emergency</option>
            <option>Urgent</option>
            <option>Recall</option>
            <option>Cosmetic / Upgrade</option>
            <option>Opt-Out Maintenance</option>
          </select>
        </div>
      </div>

      <div class="soft">
        <h3>Controls & Approvals</h3>
        <div class="field"><label class="small">Invoice Amount (USD)</label><input id="amount" type="number" min="0" step="0.01" placeholder="e.g., 425.00"></div>
        <div class="check"><input id="chkPhotos" type="checkbox"><div>Photos complete (before & after, <b>timestamp + watermark</b>)</div></div>
        <div class="check"><input id="chkTenant" type="checkbox"><div>Tenant confirmed completion</div></div>
        <div class="check"><input id="chkFYI" type="checkbox"><div><b>FYI to Owner</b> sent (required for Emergency &gt; $300)</div></div>
        <div class="check"><input id="chkOwnerOK" type="checkbox"><div><b>Owner Approval</b> attached (required for Non-Emergency &gt; $300)</div></div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       FINANCE (includes Water Bills full width on wide screens)
  ========================================================== -->
  <div id="viewFinance" class="view-pane hidden">
    <div class="badge">Finance Intake</div>
    <div class="hr"></div>

    <div class="two-col">
      <div class="soft">
        <h3>Finance Intake â€” Inputs</h3>
        <div class="field"><label>WO #</label><input id="fin_wo" type="text" placeholder="e.g., 3446201"></div>
        <div class="field"><label>Property Address</label><input id="fin_addr" type="text" placeholder="e.g., 1814 E 30th St"></div>
        <div class="field"><label>Vendor</label><input id="fin_vendor" type="text" placeholder="e.g., ABC Plumbing"></div>
        <div class="field"><label>Amount (USD)</label><input id="fin_amount" type="number" min="0" step="0.01" placeholder="e.g., 275.00"></div>
        <div class="field"><label>Approval/FYI Date</label><input id="fin_date" type="date"></div>

        <div class="hr"></div>
        <h3>Verification</h3>
        <div class="check"><input id="fin_invwo" type="checkbox"><label for="fin_invwo">Invoice WITH WO#</label></div>
        <div class="check"><input id="fin_approve" type="checkbox"><label for="fin_approve">Owner Approval (> $300 Non-Emergency) or FYI (> $300 Emergency)</label></div>
        <div class="check"><input id="fin_photos" type="checkbox"><label for="fin_photos">Before/After photos (timestamp + watermark)</label></div>
        <div class="check"><input id="fin_tenant" type="checkbox"><label for="fin_tenant">Tenant completion confirmation</label></div>
        <div class="check"><input id="fin_temp" type="checkbox"><label for="fin_temp">Temp Check present if &gt; $300</label></div>
      </div>

      <div class="soft">
        <h3>Generate</h3>
        <div class="field"><label>Output (Finance Intake Note)</label>
          <textarea id="fin_note" placeholder="Click Generate to fillâ€¦"></textarea>
        </div>
        <div class="row" style="gap:10px;">
          <button class="btn primary" id="fin_btn_gen">Generate Finance Note</button>
          <button class="btn" id="fin_btn_copy">Copy</button>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <!-- Water Bills: spans full width on large screens -->
    <div id="waterbills" class="card">
      <h3>Water Bills</h3>

      <details open id="wb_checklist">
        <summary><strong>âœ… Pre-Handoff Checklist â€” Water Bills</strong></summary>
        <div class="check"><input type="checkbox" id="wb_c1"><label for="wb_c1">Owner &amp; Tenant copies prepared &amp; named correctly</label></div>
        <div class="check"><input type="checkbox" id="wb_c2"><label for="wb_c2">5% late fee added if prior cycle unpaid</label></div>
        <div class="check"><input type="checkbox" id="wb_c3"><label for="wb_c3">Bill posted to tenant ledger + Tenant Copy attached</label></div>
        <div class="check"><input type="checkbox" id="wb_c4"><label for="wb_c4">Notices prepared (Email + Mail) and saved/linked</label></div>
        <div class="check"><input type="checkbox" id="wb_c5"><label for="wb_c5">Compared to 6-mo avg &amp; unpaid balances checked</label></div>
        <div class="check"><input type="checkbox" id="wb_c6"><label for="wb_c6">Proof/links uploaded (Drive/Buildium)</label></div>
      </details>

      <details open>
        <summary><strong>Step 1 â€¢ Process the Bill</strong></summary>
        <ol>
          <li>Open the <strong>Main Water Bill Tracking Sheet</strong> &amp; pick a bill date â‰¤ today.</li>
          <li>DPW Portal â†’ search property â†’ download latest bill.</li>
          <li>Name Owner Copy: <code>YYYYMMDD_Property_$Amount_dueMMDD</code>.</li>
          <li>Duplicate â†’ Tenant Copy (remove owner; highlight balances).</li>
          <li>If previous cycle unpaid â†’ add <strong>5% late fee</strong> in Buildium (WB Late Fee Income).</li>
          <li>Post current bill to tenant ledger (Account: Utility Income) and attach Tenant Copy.</li>
        </ol>
        <div class="field"><label><strong>Buildium memo</strong></label>
          <textarea id="wb_memo_process">Water Bill [Start Date] â€“ [End Date], $[Amount] due after [Due Date].</textarea>
        </div>
        <button type="button" class="btn" data-copy="#wb_memo_process">Copy memo</button>
      </details>

      <details>
        <summary><strong>Step 2 â€¢ Prepare the Bill</strong></summary>
        <ol>
          <li>Upload Owner Copy (Owner only) &amp; Tenant Copy (Tenant only) to Buildium.</li>
          <li>Send notices (Email + 1st Notice). Save as <code>YYYYMMDD_Property_WaterBillNotice</code>.</li>
          <li>Upload PDFs to the designated Drive folder.</li>
          <li>Email the Water Bill Process Report to: rachel@â€¦, michelle@â€¦, neha@â€¦</li>
        </ol>
        <div class="field"><label><strong>Notice quick-fill</strong></label>
          <textarea id="wb_notice_notes">Bill Due Date: [MM/DD/YYYY]
Current Amount: $[Amount]
After-Due Amount (with 5%): $[Amount x 1.05]</textarea>
        </div>
        <button type="button" class="btn" data-copy="#wb_notice_notes">Copy notes</button>
      </details>

      <details>
        <summary><strong>Step 3 â€¢ Pay the Bill</strong></summary>
        <p class="note"><em>Reminder:</em> Before paying, check the Water Bill Average doc:
          <a href="https://docs.google.com/spreadsheets/d/1_1oeQsj_TOc89CARn5rtYtNgN5lsqjIS/edit?gid=1576758348#gid=1576758348" target="_blank" rel="noopener">Open reference</a>.
        </p>
        <p><strong>Rule Summary:</strong> Pay â‰¤ $200 directly. Over $200: confirm no unpaid balances &amp; compare to 6-mo avg. Escalate if &gt;$300 (SFD) or &gt;$350 (MFD).</p>

        <div class="two-col">
          <div class="soft">
            <div class="field"><label>Bill amount (USD)</label><input id="wb_amount" type="number" inputmode="decimal" step="0.01"></div>
            <div class="field"><label>Property Type</label><select id="wb_ptype"><option value="sfd">SFD</option><option value="mfd">MFD</option></select></div>
          </div>
          <div class="soft">
            <div class="field"><label>Any unpaid balances?</label><select id="wb_unpaid"><option value="no">No</option><option value="yes">Yes</option></select></div>
            <div class="field"><label>Similar to 6-month average?</label><select id="wb_avgok"><option value="yes">Yes</option><option value="no">No</option></select></div>
          </div>
        </div>

        <div class="row" style="gap:8px;">
          <button type="button" class="btn primary" id="wb_btn_check">Check Decision</button>
          <button type="button" class="btn" id="wb_btn_reset">Reset</button>
        </div>

        <div id="wb_decision" class="note" aria-live="polite"></div>

        <div class="field"><label><strong>Buildium payment memo</strong></label>
          <textarea id="wb_memo_pay">Water Bill Paid [Service Period] â€“ $[Amount] paid on [MM/DD/YYYY].</textarea>
        </div>
        <button type="button" class="btn" data-copy="#wb_memo_pay">Copy memo</button>
      </details>
    </div>
  </div>

  <!-- =========================================================
       STALE LISTING (shows correctly)
  ========================================================== -->
  <div id="viewListings" class="view-pane hidden">
    <div class="badge">Stale Listing â€¢ Weekly Owner Report</div>
    <div class="hr"></div>
    <div class="two-col">
      <div class="soft">
        <h3>Inputs</h3>
        <div class="field"><label>Address</label><input id="sl_address" type="text"></div>
        <div class="field"><label>List Rent</label><input id="sl_rent" type="text"></div>
        <div class="field"><label>Days on Market</label><input id="sl_dom" type="number"></div>
        <div class="field"><label>Showings (7d)</label><input id="sl_showings" type="number"></div>
      </div>
      <div class="soft">
        <h3>Owner Email</h3>
        <div class="field"><label>Draft</label><textarea id="sl_out" placeholder="Summary will appear hereâ€¦"></textarea></div>
        <div class="row" style="gap:8px;">
          <button class="btn primary" id="sl_btnGen">Generate</button>
          <button class="btn" data-copy="#sl_out">Copy</button>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       DELINQUENCY (shows correctly)
  ========================================================== -->
  <div id="viewDelinquency" class="view-pane hidden">
    <div class="badge">Delinquency Handoff</div>
    <div class="hr"></div>
    <div class="two-col">
      <div class="soft">
        <h3>Case Inputs</h3>
        <div class="field"><label>Tenant Name(s)</label><input id="dlq_tenant" type="text" placeholder="Jane Smith"></div>
        <div class="field"><label>Address</label><input id="dlq_addr" type="text" placeholder="123 Bank St"></div>
        <div class="field"><label>Balance</label><input id="dlq_balance" type="text" placeholder="$1,058.30"></div>
        <div class="field"><label>Last Payment</label><input id="dlq_lastpay" type="text" placeholder="10/17 for $1,000"></div>
      </div>
      <div class="soft">
        <h3>Email to Owner/EPM</h3>
        <div class="field"><label>Output</label><textarea id="dlq_out" placeholder="Click Generateâ€¦"></textarea></div>
        <div class="row" style="gap:8px;">
          <button class="btn primary" id="dlq_btnGen">Generate</button>
          <button class="btn" data-copy="#dlq_out">Copy</button>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       NON-MAINTENANCE BILL (shows correctly)
  ========================================================== -->
  <div id="viewNonMaint" class="view-pane hidden">
    <div class="badge">Non-Maintenance Bill</div>
    <div class="hr"></div>
    <div class="two-col">
      <div class="soft">
        <h3>Inputs</h3>
        <div class="field"><label>WO / Ref</label><input id="nm_ref" type="text"></div>
        <div class="field"><label>Address</label><input id="nm_addr" type="text"></div>
        <div class="field"><label>Amount</label><input id="nm_amt" type="number" step="0.01"></div>
      </div>
      <div class="soft">
        <h3>Output</h3>
        <div class="field"><label>Comment</label><textarea id="nm_out" placeholder="Click Generateâ€¦"></textarea></div>
        <div class="row" style="gap:8px;">
          <button class="btn primary" id="nm_btnGen">Generate</button>
          <button class="btn" data-copy="#nm_out">Copy</button>
        </div>
      </div>
    </div>
  </div>

</div><!--/wrap-->

<!-- ====== SINGLE SCRIPT (pane switcher + features) ====== -->
<script>
(function(){
  if (window._pw_boot) return; window._pw_boot = true;

  /* ---------- helpers ---------- */
  const $  = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const gid = id => document.getElementById(id);
  const gval = id => { const el = gid(id); return (el && 'value' in el) ? String(el.value||'').trim() : ''; };
  const gcheck = id => { const el = gid(id); return !!(el && el.checked); };
  const show = el => el && el.classList.remove('hidden');
  const hide = el => el && el.classList.add('hidden');

  /* ---------- pane switching ---------- */
  function showPane(id){
    $$('.view-pane').forEach(p => p.classList.add('hidden'));
    const el = gid(id);
    if (el) el.classList.remove('hidden');
    try{ localStorage.setItem('pw_last_view', id); }catch(_){}
  }
  function firstExisting(){
    try{
      const last = localStorage.getItem('pw_last_view');
      if (last && gid(last)) return last;
    }catch(_){}
    const ids = ['viewMaintenance','viewFinance','viewListings','viewDelinquency','viewNonMaint'];
    for (let i=0;i<ids.length;i++){ if (gid(ids[i])) return ids[i]; }
    return null;
  }
  document.addEventListener('click', (e)=>{
    const t = e.target.closest('[data-target]');
    if (!t) return;
    const id = t.getAttribute('data-target');
    if (id && gid(id)){ e.preventDefault(); showPane(id); }
  }, {passive:true});
  if (document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ const start=firstExisting(); if(start) showPane(start); }, {once:true});
  } else {
    const start=firstExisting(); if(start) showPane(start);
  }
  window.showPane = showPane;

  /* ---------- Maintenance: flow + emergency emails ---------- */
  const OUT = {
    OUT_STANDARD:
      "Proceed with Standard Dispatch.\nâ€¢ Send owner FYI (auto-approve where applicable).",
    OUT_DELINQ:
      "Complete Delinquency SOP before dispatching.\nâ€¢ Follow delinquency checklist and handoff steps.",
    OUT_HW:
      "Proceed with scheduling via Home Warranty.\nâ€¢ Open warranty portal and follow HW process.",
    OUT_NOTIFY_OWNER:
      "Notify the rental owner of the request.\nâ€¢ Confirm if the owner will complete the work.\nâ€¢ Document plan and timeline.",
    OUT_RECALL:
      "Check for recall/warranty within 12 months.\nâ€¢ Review invoice for warranty coverage (roofing, water proofing, HVAC, carpet, etc.).\nâ€¢ Begin Recall SOP if applicable.",
    OUT_EMER:
      "Please follow the Emergency Dispatch Policy:\nStep 1: Send an FYI to the EPM for approval.\nStep 2: Once the EPM approves, send an FYI to the property owner."
  };
  (function wireMDF(){
    const flow = gid('maintDispatchFlow');
    if (!flow) return;
    const qs = Array.from(flow.querySelectorAll('.flowQ'));
    const outWrap = gid('mdf_out_wrap');
    const outBox  = gid('mdf_out');
    const copyBtn = gid('mdf_copy');
    const resetBtn= gid('mdf_reset');

    function resetFlow(){
      qs.forEach(q=>hide(q));
      show(gid('q1'));
      hide(outWrap);
      if(outBox) outBox.value='';
      hide(gid('emerg_email_wrap'));
    }

    function setOutcome(key){
      if (key==='OUT_EMER'){ show(gid('emerg_email_wrap')); buildEmergencyEmails(); }
      else { hide(gid('emerg_email_wrap')); }
      if (!OUT[key]) return;
      outBox.value = OUT[key];
      show(outWrap);
      qs.forEach(q=>hide(q));
    }

    flow.addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-next]');
      if(!b) return;
      const next = b.getAttribute('data-next');
      if (next.startsWith('OUT_')){ setOutcome(next); return; }
      qs.forEach(q=>hide(q));
      show(gid(next));
    });

    copyBtn && copyBtn.addEventListener('click', ()=>{
      const t = outBox.value || '';
      if (navigator.clipboard) navigator.clipboard.writeText(t);
      else { outBox.select && outBox.select(); document.execCommand && document.execCommand('copy'); }
      const prev = copyBtn.textContent; copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent=prev,900);
    });
    resetBtn && resetBtn.addEventListener('click', resetFlow);

    // Owner Plan acts like an emergency trigger if "Emergency" selected
    const planSel = gid('plan');
    planSel && planSel.addEventListener('change', ()=>{
      if (/emergency/i.test(planSel.value||'')) setOutcome('OUT_EMER');
      else hide(gid('emerg_email_wrap'));
    });

    resetFlow();
  })();

  // Emergency email generation
  function currency(n){
    const num = Number(String(n||'').replace(/[^0-9.]/g,''));
    return Number.isFinite(num) ? num.toLocaleString(undefined,{style:'currency',currency:'USD'}) : 'TBD';
  }
  function buildEmergencyEmails(){
    const t      = gval('maint_tenant') || '[Tenant Name]';
    const addr   = gval('maint_address')|| '[Property Address]';
    const owner  = gval('maint_owner_name') || '[Owner Name]';
    const visit  = gval('maint_vendor_visitdate') || 'TBD';
    const est    = gval('maint_vendor_estimate');
    const estText= est ? `${currency(est)} (Vendor Estimate) + 10% Surcharge\nTotal: ${currency(Number(est)*1.10)}` : 'TBD (Vendor Estimate) + 10% Surcharge\nTotal: TBD';
    const ten    = gval('maint_tenant_complaint') || '[Tenant statement]';
    const find   = gval('maint_vendor_findings')  || '[Vendor findings]';
    const reco   = gval('maint_vendor_reco')      || '[Vendor recommendation]';

    const epmSubj = `ðŸ”” EPM Approval Needed â€“ Emergency Maintenance Ticket [${t} / ${addr}]`;
    const epmBody =
`Dear EPM Team,

Please review the emergency maintenance request below and provide your approval before we notify the property owner.

Tenant Name: ${t}
Unit Address: ${addr}

Reported Issue (Tenant Complaint):
â€œ${ten}â€

Vendorâ€™s Diagnosis:
â€œ${find}â€

Proposed Work:
â€œ${reco}â€

Quoted Cost:
${estText}

Visit Date: ${visit}`;

    const ownSubj = `ðŸš¨ Emergency Dispatch FYI â€“ ${t} / ${addr}`;
    const ownBody =
`Dear ${owner},

In order to better service you and ensure timely updates, please click on the â€œView Requestâ€ green button to reply via your portal if you are viewing this message in an email form.

You have a new emergency maintenance request from PropertyWize that has been approved and dispatched for your information. Details are provided below:

Tenant Name: ${t}
Unit Address: ${addr}

Brief Description of Work Requested:
The tenant reported:
â€œ${ten}â€

Vendorâ€™s Diagnosis:
Our service provider visited the property on ${visit} and found/reported:
â€œ${find}â€

Proposed Work:
â€œ${reco}â€

Quoted Cost:
${estText}

This repair has been approved under the emergency dispatch policy to prevent further damage or safety risk.
You will receive updates once the work is completed and the invoice has been processed.`;

    const set = (id,val)=>{ const el=gid(id); if(el) el.value=val; };
    set('epm_subj', epmSubj);
    set('epm_body', epmBody);
    set('own_subj', ownSubj);
    set('own_body', ownBody);
  }
  gid('med_generate') && gid('med_generate').addEventListener('click', buildEmergencyEmails);
  // live fill while typing
  ['maint_tenant','maint_address','maint_owner_name','maint_vendor_visitdate','maint_vendor_estimate','maint_tenant_complaint','maint_vendor_findings','maint_vendor_reco']
    .forEach(id=>{ const el=gid(id); el && el.addEventListener('input', buildEmergencyEmails); });

  // Copy buttons via data-copy
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('[data-copy]');
    if(!b) return;
    const sel = b.getAttribute('data-copy');
    const el = sel ? document.querySelector(sel) : null;
    if(!el) return;
    const text = ('value' in el) ? el.value : (el.textContent||'');
    if (navigator.clipboard) navigator.clipboard.writeText(text);
    else { el.select && el.select(); document.execCommand && document.execCommand('copy'); }
    const prev=b.textContent; b.textContent='Copied!'; setTimeout(()=>b.textContent=prev,900);
  }, {passive:true});

  /* ---------- Finance: note generator & copy ---------- */
  function financeNote(){
    const wo     = gval('fin_wo') || gval('wo') || '[####]';
    const addr   = gval('fin_addr') || gval('addr') || '<Address>';
    const vendor = gval('fin_vendor') || gval('vendor') || '<Vendor>';
    const amount = gval('fin_amount') || gval('amount') || '0.00';
    const plan   = gval('plan') || '<Plan>';
    const issue  = gval('issue') || '<Type>';
    const when   = gval('fin_date') || (new Date().toLocaleString());
    const mark = b => b ? 'âœ”' : 'âœ–';

    const out =
`WO # ${wo} READY FOR FINANCE â€” ${addr} â€” ${vendor}
Owner Plan: ${plan}
Issue: ${issue} â€” Amount: $${amount}
Date/Time: ${when}

Attached in WO:
â€¢ Invoice WITH WO# â€” ${mark(gcheck('fin_invwo'))}
â€¢ Approval Type: (Standard Plan <$300, Non-emergency > $300 = APPROVAL) OR (Emergency > $300 = FYI was sent by Maintenance) Basic Plan <$150) â€” ${mark(gcheck('fin_approve'))}
â€¢ Before/After photos (timestamp + watermark) â€” ${mark(gcheck('fin_photos'))}
â€¢ Tenant completion confirmation â€” ${mark(gcheck('fin_tenant'))}
${gcheck('fin_temp') ? 'â€¢ Temp Check present if > $300 â€” âœ”' : ''}

Status: READY FOR FINANCE â€” Assigned to: FINANCE`;

    const box = gid('fin_note');
    if (box){ box.value = out; box.focus(); box.select && box.select(); }
  }
  gid('fin_btn_gen') && gid('fin_btn_gen').addEventListener('click', (e)=>{ e.preventDefault(); financeNote(); });
  gid('fin_btn_copy') && gid('fin_btn_copy').addEventListener('click', ()=>{
    const el = gid('fin_note'); if (!el) return;
    if (navigator.clipboard) navigator.clipboard.writeText(el.value||'');
    else { el.select && el.select(); document.execCommand && document.execCommand('copy'); }
  });

  /* ---------- Water Bills: decision + reset ---------- */
  function wbDecision(){
    const amt  = Number(gval('wb_amount')||0);
    const ptyp = gval('wb_ptype') || 'sfd';
    const unpaid = gval('wb_unpaid') || 'no';
    const avgok  = gval('wb_avgok') || 'yes';
    const out = gid('wb_decision');
    let msg = '';
    if (amt <= 200) msg = 'âœ… Pay directly (â‰¤ $200).';
    else {
      if (unpaid==='yes') msg += 'âš ï¸ Unpaid balances present. Clear before paying.\n';
      if (avgok==='no')   msg += 'âš ï¸ Not within 6-month average. Investigate variance.\n';
      const th = (ptyp==='mfd') ? 350 : 300;
      if (amt > th) msg += `â¬†ï¸ Escalate: amount exceeds $${th} for ${ptyp.toUpperCase()}.`;
      if (!msg) msg = 'âœ… Within rules. Proceed to pay.';
    }
    out.textContent = msg;
  }
  gid('wb_btn_check') && gid('wb_btn_check').addEventListener('click', wbDecision);
  gid('wb_btn_reset') && gid('wb_btn_reset').addEventListener('click', ()=>{
    ['wb_amount','wb_ptype','wb_unpaid','wb_avgok'].forEach(id=>{ const el=gid(id); if (!el) return; if (el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; });
    const out = gid('wb_decision'); if (out) out.textContent='';
  });

  /* ---------- Simple generators for the other two pages ---------- */
  gid('sl_btnGen') && gid('sl_btnGen').addEventListener('click', ()=>{
    const addr = gval('sl_address') || 'Unit';
    const rent = gval('sl_rent') || 'â€”';
    const dom  = gval('sl_dom') || '0';
    const sh   = gval('sl_showings') || '0';
    gid('sl_out').value =
`Weekly Owner Report â€” ${addr}
â€¢ List Rent: ${rent}
â€¢ Days on Market: ${dom}
â€¢ Showings (7d): ${sh}

Recommendation:
- Review price/condition and marketing signals; see attached market comps.`;
  });

  gid('dlq_btnGen') && gid('dlq_btnGen').addEventListener('click', ()=>{
    const t   = gval('dlq_tenant') || 'Tenant';
    const a   = gval('dlq_addr')   || 'Address';
    const bal = gval('dlq_balance')|| '$0.00';
    const lp  = gval('dlq_lastpay')|| 'â€”';
    gid('dlq_out').value =
`Manager Assigned: SYS
Voucher Tenant: No
Tenant's vs HAP Rent Portion: N/A
1. Tenant's Name: ${t}
2. Address: ${a}
3. Balance: ${bal}
4. Last Payment Received: ${lp}
5. Last Communication from Tenant: â€”
6. FTP Date: None Filed
7. Court Outcome: N/A
8. Judgment Ordered: N/A
9. Eviction Date Scheduled: None filed yet
10. Last Action Completed: â€”
11. If no eviction schedule was completed, please state the reason: â€”
12. Lease End Date: â€”
13. Tenant status in Buildium reflects collection status, meaning they are blocked from making partial payments online: â€”
14. Eligible for ROR? â€”`;
  });

  gid('nm_btnGen') && gid('nm_btnGen').addEventListener('click', ()=>{
    const ref = gval('nm_ref') || 'Ref';
    const a   = gval('nm_addr')|| 'Address';
    const amt = gval('nm_amt') || '0.00';
    gid('nm_out').value =
`Non-Maintenance Bill
Ref/WO: ${ref}
Address: ${a}
Amount: $${amt}

Entered for processing.`;
  });

})();
</script>
</body>
</html>