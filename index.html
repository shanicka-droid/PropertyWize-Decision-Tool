<!DOCTYPE html>
<html lang="en">
<head>
<style>
/* Full-width ‚ÄúWater Bills‚Äù card inside Finance view */
#viewFinance .wb-span {
  grid-column: 1 / -1;       /* spans across all grid columns */
  width: 100%;
  max-width: 1200px;         /* adjust to taste */
  margin-inline: auto;       /* centers content if container wider */
  box-sizing: border-box;
}

/* Make all inputs, selects, and textareas expand properly */
#viewFinance .wb-span .field input,
#viewFinance .wb-span .field select,
#viewFinance .wb-span .field textarea {
  width: 100%;
}

/* Keep two-column layouts neat and responsive */
#viewFinance .wb-span .two-col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  column-gap: 16px;
}

/* Optional: widen textareas for memos and notices */
#viewFinance .wb-span textarea {
  min-height: 120px;
  resize: vertical;
}
</style>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PropertyWize Decision Tool 5.0</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
.hidden { display:none !important; } /* Added !important */
  .sl-only { display: none; }
  #viewListings .sl-only { display: block; }

  :root{ --brand:#1b8e5a; --brand2:#1b6fb8; --ink:#18202a; --muted:#6b7785; --border:#e3e8ef; --bg:#f6f8fb; --ok:#1b8e5a; --warn:#b86f1b; --danger:#b81b3b; --card:#ffffff; }
  *{box-sizing:border-box}
  body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:linear-gradient(180deg,#f7fafc,#eef3f9 40%,#e9f3ef)}
  header{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.85);backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1080px;margin:0 auto;padding:14px 16px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;overflow:hidden;display:grid;place-items:center;background:#fff;border:1px solid var(--border);box-shadow:0 6px 20px rgba(24,32,42,.08)}
  .logo img{width:100%;height:100%;object-fit:contain;display:block}
  h1{margin:0;font-size:20px}
  .tag{font-size:12px;color:var(--muted)}
  main{padding:16px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:920px){.grid{grid-template-columns:320px 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 20px rgba(24,32,42,.08);padding:14px}
  .section-title{font-weight:800;text-transform:uppercase;font-size:12px;letter-spacing:.1em;color:var(--muted);margin:0 0 8px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;border:1px solid var(--border);cursor:pointer;user-select:none;background:#fff;font-weight:700;margin:0 8px 8px 0}
  .pill.active{border-color:var(--brand);box-shadow:inset 0 0 0 2px rgba(27,142,90,.15);background:linear-gradient(#fff,#f6fffb)}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#0b1420;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;margin-right:8px}
  .btn.primary{background:linear-gradient(180deg,#30b37a,#1b8e5a);color:#fff;border-color:#138254}
  .btn.blue{background:linear-gradient(180deg,#2a8ce6,#1b6fb8);color:#fff;border-color:#1b6fb8}
  .btn.warn{background:linear-gradient(180deg,#f7b064,#d28122);color:#fff;border-color:#d28122}
  .row{display:flex;flex-wrap:wrap;gap:8px}
  .hr{height:1px;background:var(--border);margin:12px 0}
  /* .hidden{display:none !important} */ /* This is defined above */
  .progress{height:10px;background:#eef2f7;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .2s ease}
  .note{font-size:13px;color:var(--muted)}
  label.small{font-size:12px;color:var(--muted)}
  .field{display:grid;gap:6px;margin:8px 0}
  input[type=text], input[type=number], input[type=date], input[type=url], select, textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fcfdfd}
  textarea{min-height:120px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .two-col{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.two-col{grid-template-columns:1fr 1fr}}
  .check{display:flex;gap:8px;align-items:flex-start;border:1px solid var(--border);border-radius:10px;padding:8px;background:#fff;margin-bottom:8px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;padding:0 6px;border-radius:6px;background:#eef2f7;border:1px solid var(--border)}
  .soft{background:#f6faff;border:1px solid var(--border);border-radius:10px;padding:10px}
  .badge{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#344354;margin-right:6px}

  /* --- Modal Styles for Alert/Confirm --- */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5);
    display: none; place-items: center; z-index: 100;
  }
  .modal-overlay.visible { display: grid; }
  .modal-box {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    padding: 24px; max-width: 400px; width: calc(100% - 32px);
  }
  .modal-box h3 { margin-top: 0; }
  .modal-box p { margin: 0 0 20px; color: var(--ink); font-size: 16px; line-height: 1.5; }
  .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
</style>
</head>
<body>
<header>
  <div class="wrap brand">
    <div class="logo"><img src="https://placehold.co/44x44/1b8e5a/ffffff?text=PW" alt="PropertyWize Logo"></div>
    <div>
      <h1>PropertyWize ‚Ä¢ Decision Tool 5.0</h1>
      <div class="tag">Role-based steps ‚Ä¢ Owner Plan aware ‚Ä¢ Works offline ‚Ä¢ Updated Oct 2025</div>
    </div>
  </div>
</header>

<main class="wrap grid">
  <section class="card">
    <div class="section-title">Select Role</div>
    <div id="rolePicker" class="row">
  <label class="pill">
    <input type="radio" name="role" value="maintenance" data-target="viewMaintenance">
    <span>üõ† Maintenance</span>
  </label>

  <label class="pill">
    <input type="radio" name="role" value="finance" data-target="viewFinance">
    <span>üíµ Finance</span>
  </label>

  <label class="pill">
    <input type="radio" name="role" value="nonmaint" data-target="viewNonMaint">
    <span>üìÑ Non-Maintenance Bill</span>
  </label>

  <label class="pill">
    <input type="radio" name="role" value="delinquency" data-target="viewDelinquency">
    <span>üí∏ Delinquency</span>
  </label>

  <label class="pill">
  <input type="radio" name="role" value="listings" data-target="viewListings">
  <span>üè° Stale Listing</span>
</label>

<label class="pill">
  <input type="radio" name="role" value="appliance" data-target="viewAppliance">
  <span>üîå Appliance</span>
</label>
</div>
    <div class="hr"></div>
    <div class="section-title">Quick Actions</div>
    <div class="row">
      <button class="btn" id="btnReset">Reset</button>
      <button class="btn blue" id="btnPrint">Print / Save PDF</button>
      <button class="btn warn" id="btnPlans">Manage Owner Plans</button>
    </div>
    <div class="hr"></div>
    <div class="section-title">Progress</div>
    <div class="progress"><div class="bar" id="progressBar"></div></div>
    <div class="note" id="progressNote">0% complete</div>
  </section>

  <!-- RIGHT COLUMN -->
  <section class="card">
     <div id="viewWelcome" class="view-pane"> 
      <h2>Welcome</h2>
      <p><strong>PropertyWize Operations Team:</strong> The PropertyWize Decision Tool centralizes our most critical workflows into one smart system that empowers every department ‚Äî Maintenance, Finance, Leasing, and Delinquency ‚Äî to work faster and more accurately. It provides step-by-step guidance for complex tasks, ensures approvals and communications are handled consistently, and automatically generates formatted notes, owner updates, and internal handoffs. This tool was built to simplify decisions, reduce errors, and keep the entire PropertyWize team aligned, informed, and accountable from start to finish.</p>
      <p class="note">Tip: Add to Home Screen in Safari/Chrome to use like an app.</p>
    </div>

    <!-- Maintenance VIEW -->
    <div id="viewMaintenance" class="view-pane hidden">
<!-- ... existing viewMaintenance HTML ... -->
<div class="card" id="maintDispatchFlow" style="margin-bottom:12px;">
<h3>Maintenance Dispatch Flow</h3>
<p class="note">Answer each question in order. The next step will appear automatically.</p>
<!-- Q1 -->
<div class="flowQ" id="q1">
  <label><strong>Is it an Emergency?</strong></label>
  <div class="row" style="gap:8px;">
    <button type="button" class="btn" data-next="OUT_EMER">Yes</button>
    <button type="button" class="btn" data-next="q2">No</button>
  </div>
</div>
<!-- Q2 -->
<div class="flowQ hidden" id="q2">
<label><strong>Is the Property in Delinquent Status?</strong></label>
<div class="row" style="gap:8px;">
<button type="button" class="btn" data-next="OUT_DELINQ">Yes</button>
<button type="button" class="btn" data-next="q3">No</button>
</div>
</div>
<!-- Q3 -->
<div class="flowQ hidden" id="q3">
<label><strong>Is the Property enrolled in a Home Warranty program?</strong></label>
<div class="row" style="gap:8px;">
<button type="button" class="btn" data-next="OUT_HW">Yes</button>
<button type="button" class="btn" data-next="q4">No</button>
</div>
</div>
<!-- Q4 -->
<div class="flowQ hidden" id="q4">
<label><strong>Will the Owner complete their own maintenance tickets?</strong></label>
<div class="row" style="gap:8px;">
<button type="button" class="btn" data-next="OUT_NOTIFY_OWNER">Yes</button>
<button type="button" class="btn" data-next="q5">No</button>
</div>
</div>
<!-- Q5 -->
<div class="flowQ hidden" id="q5">
<label><strong>Was the same issue reported within the last 12 months?</strong></label>
<div class="row" style="gap:8px;">
<button type="button" class="btn" data-next="OUT_RECALL">Yes</button>
<button type="button" class="btn" data-next="OUT_STANDARD">No</button>
</div>
</div>
<!-- Outcome -->
<div id="mdf_out_wrap" class="hidden" style="margin-top:10px;">
<div class="hr"></div>
<label><strong>Decision</strong></label>
<textarea id="mdf_out" readonly style="min-height:110px"></textarea>
<div class="row" style="gap:8px;margin-top:6px;">
<button type="button" class="btn primary" id="mdf_copy">Copy Decision</button>
<button type="button" class="btn" id="mdf_reset">Reset</button>
</div>
</div>
  <!-- ===== Emergency Email (only shows when Emergency is chosen) ===== -->
<div id="emerg_email_wrap" class="hidden" style="margin-top:12px;">
  <div class="hr"></div>
  <h3>Emergency Email Data</h3>
  <div class="row" style="gap:12px; flex-wrap:wrap;">
    <div class="field" style="flex:1 1 260px">
      <label>Tenant Name</label>
      <input id="med_tenant" type="text" placeholder="e.g., Jane Smith">
    </div>
    <div class="field" style="flex:1 1 320px">
      <label>Unit Address</label>
      <input id="med_address" type="text" placeholder="e.g., 123 Main St, Baltimore MD">
    </div>
    <div class="field" style="flex:1 1 220px">
      <label>Vendor Visit Date</label>
      <input id="med_visit" type="date">
    </div>
    <div class="field" style="flex:1 1 180px">
      <label>Vendor Estimate ($)</label>
      <input id="med_estimate" type="number" min="0" step="1" placeholder="e.g., 425">
    </div>
  </div>
  <div class="field">
    <label>Tenant Complaint (quote exact)</label>
    <textarea id="med_tenant_stmt" rows="3" placeholder="Paste what tenant wrote‚Ä¶"></textarea>
  </div>
  <div class="row" style="gap:12px; flex-wrap:wrap;">
    <div class="field" style="flex:1 1 320px">
      <label>Vendor Findings</label>
      <textarea id="med_findings" rows="3" placeholder="Diagnosis‚Ä¶"></textarea>
    </div>
    <div class="field" style="flex:1 1 320px">
      <label>Vendor Recommendation</label>
      <textarea id="med_reco" rows="3" placeholder="Proposed work‚Ä¶"></textarea>
    </div>
  </div>
  <div class="row" style="gap:8px; margin-top:6px;">
    <button type="button" class="btn primary" id="med_generate">Generate Emergency Emails</button>
  </div>
  <div class="hr"></div>
  <h3>Emergency Emails (auto-filled)</h3>
  <p class="note"><strong>Policy:</strong> Step 1: FYI to <em>EPM</em> for approval. Step 2: After EPM approves, FYI to <em>Owner</em>.</p>
  <div class="field">
    <label>EPM Subject</label>
    <input id="epm_subj" type="text" readonly>
  </div>
  <div class="field">
    <label>EPM Body</label>
    <textarea id="epm_body" rows="9" readonly></textarea>
    <div class="row" style="justify-content:flex-end; gap:8px;">
      <button type="button" class="btn" data-copy="#epm_body">Copy EPM Email</button>
    </div>
  </div>
  <div class="hr"></div>
  <div class="field">
    <label>Owner Subject</label>
    <input id="own_subj" type="text" readonly>
  </div>
  <div class="field">
    <label>Owner FYI Body</label>
    <textarea id="own_body" rows="11" readonly></textarea>
    <div class="row" style="justify-content:flex-end; gap:8px;">
      <button type="button" class="btn" data-copy="#own_body">Copy Owner Email</button>
    </div>
  </div>
</div>
</div>
      <div class="one-col">
        <div class="soft">
          <h3>WO Details</h3>
          <div class="field"><label class="small">Work Order #</label><input id="wo" type="text" placeholder="e.g., 3425886" oninput="persist()"></div>
          <div class="field"><label class="small">Property Address</label><input id="addr" type="text" placeholder="e.g., 7418 Hindon Cir" oninput="persist()"></div>
          <div class="field"><label class="small">Vendor</label><input id="vendor" type="text" placeholder="e.g., ABC Plumbing" oninput="persist()"></div>
          <div class="field">
            <label class="small">Owner Plan</label>
            <select id="plan" onchange="persist()"></select>
        <label class="small">Issue Type</label>
<select id="issue" oninput="persist();calcRules()"> <!-- FIX: oninput -->
  <option value="">Select‚Ä¶</option>
  <option>Emergency</option>
  <option>Non-Emergency</option>
  <option>Urgent</option>              <!-- NEW -->
  <option>Recall</option>              <!-- NEW -->
  <option>Cosmetic / Upgrade</option>
  <option>Opt-Out Maintenance</option> <!-- NEW -->
</select>
          </div>
          <!-- ===== Emergency Details (lightweight add-only) ===== -->
<div class="card" id="pw_emergency_details" style="margin-top:12px;">
  <h3>Emergency Details</h3>
  <div class="two-col">
    <div class="field">
      <label>Tenant Name</label>
      <input id="maint_tenant" type="text" placeholder="e.g., Anna Banana">
    </div>
    <div class="field">
      <label>Unit Address</label>
      <input id="maint_address" type="text" placeholder="e.g., 123 Maple St, City ST">
    </div>
  </div>
  <div class="two-col">
    <div class="field">
      <label>Owner Name (for greeting)</label>
      <input id="maint_owner_name" type="text" placeholder="e.g., John Doe (optional)">
    </div>
    <div class="field">
      <label>Vendor Visit Date</label>
      <input id="maint_vendor_visitdate" type="date" placeholder="">
    </div>
  </div>
  <div class="field">
    <label>Tenant Complaint (quote exact)</label>
    <textarea id="maint_tenant_complaint" rows="3" placeholder="Quote tenant‚Äôs original statement from the work order‚Ä¶"></textarea>
  </div>
  <div class="two-col">
    <div class="field">
      <label>Vendor Findings (diagnosis)</label>
      <textarea id="maint_vendor_findings" rows="3" placeholder="What the vendor found‚Ä¶"></textarea>
    </div>
    <div class="field">
      <label>Vendor Recommendation (proposed work)</label>
      <textarea id="maint_vendor_reco" rows="3" placeholder="What the vendor recommends‚Ä¶"></textarea>
    </div>
  </div>
  <div class="two-col">
    <div class="field">
      <label>Vendor Estimate (numbers only)</label>
      <input id="maint_vendor_estimate" type="number" step="0.01" min="0" placeholder="e.g., 325.00">
    </div>
    <div class="field">
      <label>Portal Link (optional)</label>
      <input id="maint_portal_link" type="url" placeholder="e.g., https://‚Ä¶">
    </div>
  </div>
</div>
        </div>
        <!-- Vendor Findings & Compliance -->
<div class="hr"></div>
<h3>Vendor Findings & Compliance</h3>
<details open>
  <summary><strong>Flags from vendor / SOP</strong></summary>
  <div class="one-col">
    <div class="soft">
      <div class="check"><input id="mt_tenant_resp" type="checkbox" onchange="persist()">
        <label for="mt_tenant_resp">Vendor confirmed tenant responsibility</label></div>
      <div class="check"><input id="mt_followup_suggested" type="checkbox" onchange="persist()">
        <label for="mt_followup_suggested">Vendor suggested follow-up work</label></div>
      <div class="check"><input id="mt_tempcheck" type="checkbox" onchange="persist()">
        <label for="mt_tempcheck">Temp check / 2nd opinion needed</label></div>
      <div class="check"><input id="mt_optout" type="checkbox" onchange="persist()">
        <label for="mt_optout">Opt-out maintenance (use opt-out path)</label></div>
    </div>
    <div class="soft">
      <div class="check"><input id="mt_lease_violation" type="checkbox" onchange="persist()">
        <label for="mt_lease_violation">Trigger Lease Violation Notice</label></div>
      <div class="check"><input id="mt_tenant_chargeback" type="checkbox" onchange="persist()">
        <label for="mt_tenant_chargeback">Tenant responsible but work done (chargeback)</label></div>
      <div class="field"><label>Chargeback amount (if applicable)</label>
        <input id="mt_chargeback_amt" type="text" placeholder="$125.00" oninput="persist()"></div>
      <div class="check"><input id="mt_forward_fin" type="checkbox" checked onchange="persist()">
        <label for="mt_forward_fin">Forward to Finance when complete</label></div>
    </div>
  </div>
</details>
        <div class="soft">
          <h3>Controls & Approvals</h3>
          <div class="field"><label class="small">Invoice Amount (USD)</label><input id="amount" type="number" min="0" step="0.01" placeholder="e.g., 425.00" oninput="persist();calcRules()"></div>
          <div class="check"><input id="chkPhotos" type="checkbox" onchange="persist()"><div>Photos complete (before & after, <b>timestamp + watermark</b>)</div></div>
          <div class="check"><input id="chkTenant" type="checkbox" onchange="persist()"><div>Tenant confirmed completion</div></div>
          <div class="check"><input id="chkFYI" type="checkbox" onchange="persist()"><div><b>FYI to Owner</b> sent (required for Emergency &gt; $300)</div></div>
          <div class="check"><input id="chkOwnerOK" type="checkbox" onchange="persist()"><div><b>Owner Approval</b> attached (required for Non‚ÄëEmergency &gt; $300)</div></div>
        </div>
      </div>
<!-- Buildium Note Output -->
<div class="hr"></div>
<h3>Buildium Note / Copy Output</h3>
<p class="note">Use this section to generate a clean Buildium note template.</p>
<textarea id="mt_note" style="width:100%;min-height:120px;"
  placeholder="Click 'Generate Note' to create formatted output..."></textarea>
<div class="row" style="margin-top:10px;">
  <button class="btn primary" onclick="genMaintNote()">Generate Note</button>
  <button class="btn" onclick="copyMaintNote()">Copy to Clipboard</button>
</div>
      <div class="hr"></div>
      <div class="soft">
        <h3>Policy Guidance</h3>
        <div id="policy" class="note">Enter amount & issue type to see policy cues‚Ä¶</div>
      </div>
      <div class="hr"></div>
      <div class="two-col">
        <div>
          <h3>Dispatch & Completion</h3>
          <div class="check"><input id="chkVendorApproved" type="checkbox" onchange="persist()"><div>Vendor is approved & scheduled in Buildium</div></div>
          <div class="check"><input id="chkWOStatus" type="checkbox" onchange="persist()"><div>WO status set to <span class="kbd">Vendor Scheduled</span></div></div>
          <div class="check"><input id="chkInvoiceWO" type="checkbox" onchange="persist()"><div>Invoice has <b>WO#</b> printed on it</div></div>
        </div>
        <div>
          <h3>Handoff to Finance</h3>
          <div class="check"><input id="chkAllDocs" type="checkbox" onchange="persist()"><div>All docs attached: invoice, approvals/FYI, photos, tenant confirm</div></div>
          <div class="check"><input id="chkReady" type="checkbox" onchange="persist()"><div>Status set to <span class="kbd">READY FOR FINANCE</span>, assigned to Finance, team notified</div></div>
          <button class="btn primary" onclick="genHandoff()">Generate Handoff Note</button>
          <textarea id="handoff" placeholder="Click Generate to fill‚Ä¶"></textarea>
        </div>
      </div>
    </div>
    <!-- ========= APPLIANCE TICKET PROCESSING (Maintenance) ========= -->
<!-- Appliance VIEW -->
<div id="viewAppliance" class="view-pane hidden">
<div class="hr"></div>
<h3>Appliance Ticket Processing</h3>
<p class="note">Use this tool to process appliance tickets end-to-end: delinquency check, essential vs non-essential, troubleshooting, inspection details, vendor review, options, and EPM email.</p>
<!-- 1) Ticket & Delinquency -->
<div class="two-col">
  <div class="soft">
    <div class="field"><label>WO#</label><input id="appl_wo" type="text" placeholder="e.g., WO-12345"></div>
    <div class="field"><label>Property Address</label><input id="appl_address" type="text" placeholder="123 Main St, City ST"></div>
    <div class="field"><label>Unit</label><input id="appl_unit" type="text" placeholder="Apt 2B"></div>
    <div class="field"><label>Tenant Name</label><input id="appl_tenant" type="text" placeholder="Jane Doe"></div>
    <div class="field">
      <label>Appliance Type</label>
      <select id="appl_type">
        <option value="">Select‚Ä¶</option>
        <option>Refrigerator</option>
        <option>Oven / Stove / Range</option>
        <option>Dishwasher</option>
        <option>Microwave</option>
        <option>Washer</option>
        <option>Dryer</option>
      </select>
    </div>
  </div>
  <div class="soft">
    <div class="field"><label>Tenant Balance (USD)</label><input id="appl_balance" type="text" placeholder="$0.00"></div>
    <div class="field">
      <label>Essential vs Non-Essential</label>
      <select id="appl_priority">
        <option value="">Auto (based on type)</option>
        <option value="essential">Essential (Refrigerator, Oven/Stove/Range)</option>
        <option value="nonessential">Non-Essential (Microwave, Washer, Dryer, Dishwasher)</option>
      </select>
    </div>
    <div class="field"><label>EPM (Manager)</label><input id="appl_epm" type="text" placeholder="(Optional) e.g., Michelle / Shanicka"></div>
    <div class="field"><label>Tenant Complaint (from WO)</label><input id="appl_complaint" type="text" placeholder="e.g., fridge not cooling"></div>
  </div>
</div>
<!-- 2) Troubleshooting -->
<div class="hr"></div>
<h4>Tenant Troubleshooting</h4>
<div class="field">
  <div class="row" style="margin-bottom:6px;">
    <button type="button" class="btn" onclick="appl_insertTroubleshooting()">Insert basic troubleshooting template</button>
  </div>
  <textarea id="appl_troubleshoot" placeholder="Record steps provided to tenant and result‚Ä¶"></textarea>
</div>
<!-- 3) Appliance Details (Inspection / Tenant) -->
<div class="hr"></div>
<h4>Appliance Details</h4>
<div class="two-col">
  <div class="soft">
    <div class="field"><label>Brand</label><input id="appl_brand" type="text" placeholder="Whirlpool"></div>
    <div class="field"><label>Model #</label><input id="appl_model" type="text" placeholder="WRS325FDAM"></div>
    <div class="field"><label>Serial #</label><input id="appl_serial" type="text" placeholder="SER1234567"></div>
    <div class="field"><label>Color</label><input id="appl_color" type="text" placeholder="Stainless / White"></div>
    <div class="field"><label>Age (years, approximate)</label><input id="appl_age" type="text" placeholder="e.g., 8"></div>
  </div>
  <div class="soft">
    <div class="field"><label>Photo Album Link (Drive)</label><input id="appl_album" type="text" placeholder="https://drive.google.com/‚Ä¶"></div>
    <div class="field"><label>Info Source</label>
      <select id="appl_info_source">
        <option>PW Inspection</option>
        <option>Tenant Provided</option>
        <option>Vendor</option>
      </select>
    </div>
    <div class="row" style="margin-top:6px;">
      <a class="btn" href="http://www.appliance411.com/service/date-code.php" target="_blank" rel="noopener">Appliance411 (Age Lookup)</a>
      <a class="btn" href="https://propertywize.managebuilding.com/manager/public/authentication/login?returnUrl=%2Fmanager%2Fapp%2Fdraft-leases%2Fdraft%2F101559%2Fsummary%3FopenSignModal%3Dtrue%26signatureRequestId%3D7cd1654a-b69c-4b35-ab4f-b1580df7a6df" target="_blank" rel="noopener">Open Buildium</a>
    </div>
  </div>
</div>
<!-- 4) Vendor Coordination -->
<div class="hr"></div>
<h4>Vendor Coordination</h4>
<div class="two-col">
  <div class="soft">
    <div class="field"><label>Preferred Vendor</label><input id="appl_vendor" type="text" value="NT Appliance ‚Äì Ahmed"></div>
    <div class="field"><label>Vendor Recommendation</label>
      <select id="appl_vendor_reco">
        <option value="">Select‚Ä¶</option>
        <option>Repair</option>
        <option>Replace</option>
        <option>Unknown / Awaiting review</option>
      </select>
    </div>
  </div>
  <div class="soft">
    <div class="check"><input id="appl_sent_vendor" type="checkbox"><label for="appl_sent_vendor">Sent ticket details & photos to vendor</label></div>
    <div class="check"><input id="appl_vendor_reviewed" type="checkbox"><label for="appl_vendor_reviewed">Vendor reviewed and advised next step</label></div>
  </div>
</div>
<!-- 5) Replacement Options (2 NEW + 1 USED) -->
<div class="hr"></div>
<h4>Replacement Options (verify pricing & requirements)</h4>
<p class="note">Provide two <b>Brand New</b> options (‚â•4.0 rating & ‚â•500 reviews) and one <b>USED</b> option with photo link. Verify delivery/kit pricing before submission.</p>
<div class="two-col">
  <div class="soft">
    <div class="field"><label>Option 1 ‚Äî Brand NEW (Name/URL/Price/Rating/Reviews)</label><input id="appl_opt1" type="text" placeholder="LG LDFN4542... | https://... | $699 | 4.3 | 1,204"></div>
    <div class="field"><label>Option 2 ‚Äî Brand NEW (Name/URL/Price/Rating/Reviews)</label><input id="appl_opt2" type="text" placeholder="Samsung ... | https://... | $649 | 4.2 | 980"></div>
    <div class="check"><input id="appl_verify_price" type="checkbox"><label for="appl_verify_price">Verified current delivery/kit pricing (Lowe‚Äôs & Home Depot)</label></div>
  </div>
  <div class="soft">
    <div class="field"><label>Option 3 ‚Äî USED (Name/URL/Price/PhotoLink/Notes)</label><input id="appl_opt3" type="text" placeholder="Whirlpool USED ... | https://... | $350 | Photo: https://..."></div>
    <div class="field"><label>Notes to EPM (optional)</label><input id="appl_notes" type="text" placeholder="Any context, constraints, measurements, etc."></div>
  </div>
</div>
<!-- 6) Pre-Handoff Checklist -->
<div class="hr"></div>
<h4>Pre-Handoff Checklist</h4>
<details open id="appl_checklist">
  <summary><strong>Complete before Generate</strong></summary>
  <div class="check"><input id="appl_ck_delinquency" type="checkbox"><label for="appl_ck_delinquency">Delinquency checked in Buildium</label></div>
  <div class="check"><input id="appl_ck_ack" type="checkbox"><label for="appl_ck_ack">Acknowledgement email sent to tenant</label></div>
  <div class="check"><input id="appl_ck_details" type="checkbox"><label for="appl_ck_details">Brand/Model/Serial/Color captured (or requested)</label></div>
  <div class="check"><input id="appl_ck_vendor" type="checkbox"><label for="appl_ck_vendor">Vendor consulted (reviewed ticket & photos)</label></div>
  <div class="check"><input id="appl_ck_options" type="checkbox"><label for="appl_ck_options">2 NEW + 1 USED options prepared</label></div>
  <div class="check"><input id="appl_ck_photos" type="checkbox"><label for="appl_ck_photos">Photo album link added</label></div>
</details>
<!-- 7) Outputs -->
<div class="row">
  <button type="button" class="btn primary" onclick="appl_generate()">Generate EPM Email</button>
  <button type="button" class="btn" onclick="appl_copy('appl_email_out')">Copy Email</button>
  <button type="button" class="btn" onclick="appl_clear()">Clear</button>
</div>
<div class="field">
  <label>EPM Email (preview)</label>
  <textarea id="appl_email_out" readonly style="min-height:220px"></textarea>
</div>
<div class="row">
  <button type="button" class="btn" onclick="appl_copy('appl_handoff')">Copy Handoff Comment</button>
  <button type="button" class="btn" onclick="appl_copy('appl_deferral')">Copy Tenant Deferral Email</button>
</div>
<div class="field">
  <label>Handoff Comment (Buildium/)</label>
  <textarea id="appl_handoff" readonly></textarea>
</div>
<div class="field">
  <label>Tenant Deferral Email (if delinquent & non-essential)</label>
  <textarea id="appl_deferral" readonly></textarea>
</div>
</div> <!-- /#viewAppliance -->
    <!-- Finance VIEW -->
   <div id="viewFinance" class="view-pane hidden">
      <div class="badge">Temp Check required if &gt; $300</div>
      <div class="hr"></div>
      <div class="two-col">
        <div class="soft">
          <h3>WO & Invoice</h3>
          <div class="field"><label class="small">Work Order #</label><input id="fin_wo" type="text" oninput="persist()"></div>
          <div class="field"><label class="small">Property Address</label><input id="fin_addr" type="text" oninput="persist()"></div>
          <div class="field"><label class="small">Vendor</label><input id="fin_vendor" type="text" oninput="persist()"></div>
          <div class="field"><label class="small">Invoice Amount</label><input id="fin_amount" type="number" step="0.01" oninput="persist()"></div>
          <div class="field"><label class="small">Approval / FYI Date</label><input id="fin_date" type="text" placeholder="YYYY-MM-DD" oninput="persist()"></div>
        </div>
        <div class="soft">
          <h3>Intake Verification</h3>
          <div class="check"><input id="fin_invwo" type="checkbox" onchange="persist()"><div>Invoice attached WITH <b>WO#</b></div></div>
          <div class="check"><input id="fin_approve" type="checkbox" onchange="persist()"><div>Owner Approval (&gt; $300 non‚Äëemergency) or <b>FYI</b> (&gt; $300 emergency)</div></div>
          <div class="check"><input id="fin_photos" type="checkbox" onchange="persist()"><div>Before/After photos present (timestamp + watermark)</div></div>
          <div class="check"><input id="fin_tenant" type="checkbox" onchange="persist()"><div>Tenant completion confirmation present</div></div>
          <div class="check"><input id="fin_temp" type="checkbox" onchange="persist()"><div><b>Temp Check</b> note present if &gt; $300</div></div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="two-col">
        <div>
          <h3>Buildium & Spreadsheet</h3>
          <div class="check"><input id="fin_enter" type="checkbox" oninput="persist()"><div>Entered bill via <b>Maintenance ‚Üí Work Orders ‚Üí Enter Bill</b></div></div>
          <div class="check"><input id="fin_link" type="checkbox" oninput="persist()"><div>Bill saved & linked to WO; vendor/property/expense verified</div></div>
          <div class="check"><input id="fin_sheet" type="checkbox" oninput="persist()"><div>Added to Finance Spreadsheet (WO#, vendor, amount, approval/FYI date)</div></div>
          <div class="check"><input id="fin_epm" type="checkbox" oninput="persist()"><div>EPM Approval received (‚ÄúApproved for Payment‚Äù)</div></div>
        </div>
        <div>
          <h3>Payment & Recordkeeping</h3>
          <div class="check"><input id="fin_pay" type="checkbox" oninput="persist()"><div>Payment issued (Check / ACH / Card)</div></div>
          <div class="check"><input id="fin_upload" type="checkbox" oninput="persist()"><div>Paid invoice uploaded to Files ‚Üí Invoices/Payments ‚Üí shared with Owner</div></div>
          <div class="check"><input id="fin_done" type="checkbox" oninput="persist()"><div>Spreadsheet updated with payment date/status; copy saved to Drive (‚ÄúInvoices ‚Äì [Date]‚Äù)</div></div>
          <button class="btn primary" onclick="genFinance()">Generate Finance Intake Note</button>
          <textarea id="fin_note" placeholder="Click Generate to fill‚Ä¶"></textarea>
        </div>
      </div>
<div class="hr"></div>
<div class="soft soft--full">
  <div id="waterbills" class="card wb-span">
  <h3>Water Bills</h3>
<details open id="wb_checklist">
<summary><strong>‚úÖ Pre-Handoff Checklist ‚Äî Water Bills</strong></summary>
<div class="check"><input type="checkbox" id="wb_c1"><label for="wb_c1">Owner &amp; Tenant copies prepared &amp; named correctly</label></div>
<div class="check"><input type="checkbox" id="wb_c2"><label for="wb_c2">5% late fee added if prior cycle unpaid</label></div>
<div class="check"><input type="checkbox" id="wb_c3"><label for="wb_c3">Bill posted to tenant ledger + Tenant Copy attached</label></div>
<div class="check"><input type="checkbox" id="wb_c4"><label for="wb_c4">Notices prepared (Email + Mail) and saved/linked</label></div>
<div class="check"><input type="checkbox" id="wb_c5"><label for="wb_c5">Compared to 6-mo avg &amp; unpaid balances checked</label></div>
<div class="check"><input type="checkbox" id="wb_c6"><label for="wb_c6">Proof/links uploaded (Drive/Buildium)</label></div>
</details>
<details open>
<summary><strong>Step 1 ‚Ä¢ Process the Bill</strong></summary>
<ol>
<li>Open the <strong>Main Water Bill Tracking Sheet</strong> &amp; pick a bill date ‚â§ today.</li>
<li>DPW Portal ‚Üí search property ‚Üí download latest bill.</li>
<li>Name Owner Copy: <code>YYYYMMDD_Property_$Amount_dueMMDD</code>.</li>
<li>Duplicate ‚Üí Tenant Copy (remove owner; highlight balances).</li>
<li>If previous cycle unpaid ‚Üí add <strong>5% late fee</strong> in Buildium (WB Late Fee Income).</li>
<li>Post current bill to tenant ledger (Account: Utility Income) and attach Tenant Copy.</li>
</ol>
<div class="field"><label><strong>Buildium memo</strong></label>
<textarea id="wb_memo_process">Water Bill [Start Date] ‚Äì [End Date], $[Amount] due after [Due Date].</textarea>
</div>
<button type="button" class="btn" onclick="pw_copyFrom('wb_memo_process')">Copy memo</button>
</details>
<details>
<summary><strong>Step 2 ‚Ä¢ Prepare the Bill</strong></summary>
<ol>
<li>Upload Owner Copy (Owner only) &amp; Tenant Copy (Tenant only) to Buildium.</li>
<li>Send notices (Email + 1st Notice). Save as <code>YYYYMMDD_Property_WaterBillNotice</code>.</li>
<li>Upload PDFs to the designated Drive folder.</li>
<li>Email the Water Bill Process Report to: rachel@‚Ä¶, michelle@‚Ä¶, neha@‚Ä¶</li>
</ol>
<div class="field"><label><strong>Notice quick-fill</strong></label>
<textarea id="wb_notice_notes">Bill Due Date: [MM/DD/YYYY]
Current Amount: $[Amount]
After-Due Amount (with 5%): $[Amount x 1.05]</textarea>
</div>
<button type="button" class="btn" onclick="pw_copyFrom('wb_notice_notes')">Copy notes</button>
</details>
<details>
<summary><strong>Step 3 ‚Ä¢ Pay the Bill</strong></summary>
<p><em>Reminder:</em> Before paying, check the Water Bill SOP doc: <a href="https://drive.google.com/file/d/1_1oeQsj_TOc89CARn5rtYtNgN5lsqjIS/view?ts=69076e10" target="_blank" rel="noopener">Open reference</a>.</p>
<p><strong>Rule Summary:</strong> Pay ‚â§ $200 directly. Over $200: confirm no unpaid balances &amp; compare to 6-mo avg. Escalate if &gt;$300 (SFD) or &gt;$350 (MFD).</p>
<div class="two-col">
<div class="soft">
<div class="field"><label>Bill amount (USD)</label><input id="wb_amount" type="number" inputmode="decimal" step="0.01"></div>
<div class="field"><label>Property Type</label><select id="wb_ptype"><option value="sfd">SFD</option><option value="mfd">MFD</option></select></div>
</div>
<div class="soft">
<div class="field"><label>Any unpaid balances?</label><select id="wb_unpaid"><option value="no">No</option><option value="yes">Yes</option></select></div>
<div class="field"><label>Similar to 6-month average?</label><select id="wb_avgok"><option value="yes">Yes</option><option value="no">No</option></select></div>
</div>
</div>
<div class="row">
<button type="button" class="btn primary" onclick="pw_decideWB()">Check Decision</button>
<button type="button" class="btn" onclick="pw_resetWB()">Reset</button>
</div>
<div id="wb_decision" class="note" aria-live="polite"></div>
<div class="field"><label><strong>Buildium payment memo</strong></label>
<textarea id="wb_memo_pay">Water Bill Paid [Service Period] ‚Äì $[Amount] paid on [MM/DD/YYYY].</textarea>
</div>
<button type="button" class="btn" onclick="pw_copyFrom('wb_memo_pay')">Copy memo</button>
</details>
<details open>
<summary><strong>Handoff Tool (Water Bills ‚Üí ‚Ä¶)</strong></summary>
<div class="two-col">
<div class="soft">
<div class="field"><label>From (role)</label><select id="ho_from_wb"><option>Finance ‚Äì Water Bills</option><option>Finance</option><option>Operations/EPM</option><option>Owner Comms</option></select></div>
<div class="field"><label>To (role)</label><select id="ho_to_wb"><option>Operations/EPM</option><option>Owner Comms</option><option>Finance</option><option>Maintenance</option><option>Leasing</option></select></div>
</div>
<div class="soft">
<div class="field"><label>To (person)</label><input id="ho_person_wb" type="text" placeholder="e.g., Rachel S."></div>
<div class="field"><label>Due date</label><input id="ho_due_wb" type="date"></div>
</div>
</div>
<div class="field"><label>Bill Ref / Account # / Link</label><input id="ho_ref_wb" type="text"></div>
<div class="field"><label>Tags</label><input id="ho_tags_wb" type="text" placeholder="#water #urgent #owner-approval"></div>
<div class="field"><label>Decision / Action taken</label><textarea id="ho_decision_wb" placeholder="Paste decision from Step 3"></textarea></div>
<div class="field"><label>Threshold / SOP basis</label><textarea id="ho_threshold_wb" placeholder="SFD>$300 escalate ‚Ä¢ MFD>$350 escalate ‚Ä¢ within 6-mo avg ‚Ä¢ no unpaid balances"></textarea></div>
<div class="field"><label>Summary / Next steps (ask)</label><textarea id="ho_summary_wb"></textarea></div>
<div class="field"><label>Blocking items</label><textarea id="ho_block_wb"></textarea></div>
<div class="field"><label>Attachments / Proof</label><textarea id="ho_attach_wb"></textarea></div>
<div class="field"><label>Notify (emails)</label><input id="ho_notify_wb" type="text" placeholder="rachel@‚Ä¶, neha@‚Ä¶, epm@‚Ä¶"></div>
<div class="row">
<button type="button" class="btn primary" onclick="pw_genWB()">Generate</button>
<button type="button" class="btn" onclick="pw_copyFrom('ho_out_bu_wb')">Copy Buildium Comment</button>
<button type="button" class="btn" onclick="pw_copyFrom('ho_out_em_wb')">Copy Email Draft</button>
<button type="button" class="btn" onclick="pw_clearWB()">Clear</button>
</div>
<div class="field"><label>Buildium Comment</label><textarea id="ho_out_bu_wb" readonly></textarea></div>
<div class="field"><label>Email Draft (Subject + Body)</label><textarea id="ho_out_em_wb" readonly></textarea></div>
</details>
</div>
</div>
    </div>

    <!-- Non-maintenance -->
    <div id="viewNonMaint"  class="view-pane hidden">
      <h3>Non‚ÄëMaintenance Bill ‚Äî Simple Flow</h3>
      <div class="check"><input id="nm_record" type="checkbox" onchange="persist()"><div>Accounting ‚Üí Bills ‚Üí Record Bill (vendor, property, expense, due date, memo)</div></div>
      <div class="check"><input id="nm_epm" type="checkbox" onchange="persist()"><div>Submit to EPM for approval</div></div>
      <div class="check"><input id="nm_pay" type="checkbox" onchange="persist()"><div>Process payment & upload receipt to Files ‚Üí Invoices/Payments</div></div>
<div class="hr"></div>
<h3>Non-Maintenance Bill Handoff</h3>
<details open id="nmb_checklist">
<summary><strong>‚úÖ Pre-Handoff Checklist ‚Äî Non-Maintenance Bill</strong></summary>
<div class="check"><input type="checkbox" id="nb_c1"><label for="nb_c1">Invoice verified vs. PO/Agreement</label></div>
<div class="check"><input type="checkbox" id="nb_c2"><label for="nb_c2">Coding complete (chart of accounts)</label></div>
<div class="check"><input type="checkbox" id="nb_c3"><label for="nb_c3">Owner/Property allocation correct</label></div>
<div class="check"><input type="checkbox" id="nb_c4"><label for="nb_c4">Docs uploaded (PDF/Proof)</label></div>
<div class="check"><input type="checkbox" id="nb_c5"><label for="nb_c5">Next action &amp; due date chosen</label></div>
</details>
<details open>
<summary><strong>Handoff Tool (Non-Maintenance Bill ‚Üí ‚Ä¶)</strong></summary>
<div class="two-col">
<div class="soft">
<div class="field"><label>From (role)</label>
<select id="ho_from_nb">
<option>Non-Maintenance Bill</option>
<option>Finance</option>
<option>Operations/EPM</option>
<option>Owner Comms</option>
</select>
</div>
<div class="field"><label>To (role)</label>
<select id="ho_to_nb">
<option>Finance</option>
<option>Operations/EPM</option>
<option>Owner Comms</option>
<option>Maintenance</option>
<option>Leasing</option>
</select>
</div>
</div>
<div class="soft">
<div class="field"><label>To (person)</label><input id="ho_person_nb" type="text" placeholder="e.g., Rachel"></div>
<div class="field"><label>Due date</label><input id="ho_due_nb" type="date"></div>
</div>
</div>
<div class="field"><label>Invoice Ref / Link</label><input id="ho_ref_nb" type="text" placeholder="Invoice# / Buildium URL"></div>
<div class="field"><label>Tags</label><input id="ho_tags_nb" type="text" placeholder="#bill #approval #owner-pay"></div>
<div class="field"><label>Summary / Ask</label><textarea id="ho_summary_nb"></textarea></div>
<div class="field"><label>Blocking items</label><textarea id="ho_block_nb"></textarea></div>
<div class="field"><label>Attachments / Proof</label><textarea id="ho_attach_nb"></textarea></div>
<div class="field"><label>Notify (emails)</label><input id="ho_notify_nb" type="text" placeholder="rachel@‚Ä¶, finance@‚Ä¶"></div>
<div class="row">
<button type="button" class="btn primary" onclick="pwNM_gen()">Generate</button>
<button type="button" class="btn" onclick="pwNM_copy('ho_out_bu_nb')">Copy Buildium Comment</button>
<button type="button" class="btn" onclick="pwNM_copy('ho_out_em_nb')">Copy Email Draft</button>
<button type="button" class="btn" onclick="pwNM_clear()">Clear</button>
</div>
<div class="field"><label>Buildium Comment</label><textarea id="ho_out_bu_nb" readonly></textarea></div>
<div class="field"><label>Email Draft (Subject + Body)</label><textarea id="ho_out_em_nb" readonly></textarea></div>
</details>
    </div>
<!-- ==== Delinquency Handoff (inside main card) ==== -->
<div id="viewDelinquency" class="view-pane hidden">
<h2>Delinquency Handoff Tool</h2>
<p class="note">
Summarize tenants with balances over 30+ days and confirm SOP steps.
Complete the checklist to enable Generate.
</p>
<div class="hr"></div>
<h3>‚úÖ Pre-handoff Checklist</h3>
<details open id="dlq_checklist">
<summary><strong>Complete before Generate</strong></summary>
<div class="check"><input type="checkbox" id="dlq_c1" onchange="persist()"><label for="dlq_c1">Balance verified in Buildium</label></div>
<div class="check"><input type="checkbox" id="dlq_c2" onchange="persist()"><label for="dlq_c2">FTP notice sent & documented</label></div>
<div class="check"><input type="checkbox" id="dlq_c3" onchange="persist()"><label for="dlq_c3">Court status updated</label></div>
<div class="check"><input type="checkbox" id="dlq_c4" onchange="persist()"><label for="dlq_c4">Eviction step set or reason given</label></div>
<div class="check"><input type="checkbox" id="dlq_c5" onchange="persist()"><label for="dlq_c5">Tenant status = Collection</label></div>
<div class="check"><input type="checkbox" id="dlq_c6" onchange="persist()"><label for="dlq_c6">Maintenance auto-dispatch disabled if $500+</label></div>
</details>
<div class="hr"></div>
<h3>Delinquency Details</h3>
<div class="two-col">
<div class="soft">
<div class="field"><label>Tenant name</label><input id="dlq_tenant" type="text" oninput="persist()"></div>
<div class="field"><label>Address</label><input id="dlq_address" type="text" oninput="persist()"></div>
<div class="field"><label>Rent balance</label><input id="dlq_rent" type="text" oninput="persist()"></div>
<div class="field"><label>Utility balance</label><input id="dlq_util" type="text" oninput="persist()"></div>
<div class="field"><label>Misc balance</label><input id="dlq_misc" type="text" oninput="persist()"></div>
<div class="field"><label>Fees/Late Fees</label><input id="dlq_fees" type="text" oninput="persist()"></div> 
<div class="field"> <label>Total balance</label><input id="dlq_total" type="text" oninput="persist()"></div>
<div class="field"><label>Last payment received</label><input id="dlq_lastpay" type="text" oninput="persist()"></div>
<div class="field"><label>Last communication</label><input id="dlq_lastcomm" type="text" oninput="persist()"></div>
</div>
<div class="soft">
<div class="field"><label>FTP date</label><input id="dlq_ftp" type="text" placeholder="e.g., 10/26/2025 or Not Scheduled" oninput="persist()"></div>
<div class="field"><label>Court outcome</label><input id="dlq_court" type="text" oninput="persist()"></div>
<div class="field"><label>Judgment ordered</label><input id="dlq_judgment" type="text" oninput="persist()"></div>
<div class="field"><label>Eviction date</label><input id="dlq_eviction" type="text" oninput="persist()"></div>
<div class="field"><label>Reason no eviction</label><input id="dlq_noevict_reason" type="text" oninput="persist()"></div>
<div class="field"><label>Lease end date</label><input id="dlq_leaseend" type="text" oninput="persist()"></div>
<div class="field"><label>Last PW action</label><input id="dlq_lastaction" type="text" oninput="persist()"></div>
</div>
</div>
<div class="row">
<button class="btn primary" onclick="window.dlq_generate()">Generate</button>
<button class="btn" onclick="window.dlq_copy('dlq_email_body')">Copy Comment</button> <!-- CHANGED: copy email body -->
<button class="btn" onclick="window.dlq_clear()">Clear</button>
</div>
<div class="hr"></div>
<h3>Delinquency Contact & Email</h3>
<div class="two-col">
  <div class="field">
    <label>Manager Assigned</label>
    <input id="dlq_manager" type="text" placeholder="e.g., SYS" oninput="persist()">
  </div>
  <div class="field">
    <label>Voucher Tenant?</label>
    <select id="dlq_voucher" onchange="persist()">
      <option value="" selected>‚Äî Select ‚Äî</option>
      <option>Yes</option>
      <option>No</option>
    </select>
  </div>
  <div class="field">
    <label>Tenant vs HAP Rent Portion</label>
    <input id="dlq_rentportion" type="text" placeholder="e.g., N/A - Rent is $1,674 + $25 RBP" oninput="persist()">
  </div>
  <div class="field">
    <label>Buildium Collection Block (blocked from partial payments online?)</label>
    <select id="dlq_blocked" onchange="persist()">
      <option value="" selected>‚Äî Select ‚Äî</option>
      <option>Yes</option>
      <option>No</option>
    </select>
  </div>
  <div class="field">
    <label>Eligible for ROR?</label>
    <select id="dlq_ror" onchange="persist()">
      <option value="" selected>‚Äî Select ‚Äî</option>
      <option>Yes</option>
      <option>No</option>
    </select>
  </div>
</div>
<div class="hr"></div>
<h3>Email Draft</h3>
<div class="two-col">
  <div class="field">
    <label>To</label>
    <input id="dlq_email_to" type="text" placeholder="owner@example.com" oninput="persist()">
  </div>
  <div class="field">
    <label>CC</label>
    <input id="dlq_email_cc" type="text" placeholder="epm@example.com" oninput="persist()">
  </div>
</div>
<div class="soft">
  <div class="field">
    <label>Subject</label>
    <input id="dlq_email_subj" type="text" placeholder="Delinquency Update ‚Äì [Tenant]" oninput="persist()">
  </div>
  <div class="field">
    <label>Preview</label>
    <textarea id="dlq_email_body" readonly style="min-height:220px"></textarea>
  </div>
  <div class="row" style="gap:8px;">
    <button class="btn" id="dlq_email_preview">Preview</button>
    <button class="btn primary" id="dlq_email_send">Send Email</button>
  </div>
</div>
</div>

<!-- ==== /Delinquency Handoff ==== -->
  <!-- ==== Stale Listing VIEW (Owner Report) ==== -->
<div id="viewListings" class="view-pane hidden">
<h2>Stale Listing ‚Ä¢ Weekly Owner Report</h2>
<p class="note">
    For any unit &gt; 14 days with no apps OR ‚â• 30 days with no approved applicants.
    Drafts go to EPM for approval before sending to owner.
</p>
<div class="hr"></div>
<h3>Listing Details</h3>
<div class="two-col">
    <div class="soft">
      <div class="field"><label>Property Address</label><input id="sl_address" type="text" placeholder="123 Main St, City ST" oninput="persist()"></div>
      <div class="field"><label>Owner Name (optional)</label><input id="sl_owner" type="text" placeholder="e.g., John Smith" oninput="persist()"></div>
      <div class="field"><label>Date Listed</label><input id="sl_listed" type="date" onchange="sl_calcDOM();persist()"></div>
      <div class="field"><label>List Rent (USD)</label><input id="sl_rent" type="text" placeholder="$1,895" oninput="persist()"></div>
    </div>
    <div class="soft">
      <div class="field"><label>Days on Market (DOM)</label><input id="sl_dom" type="number" placeholder="auto" readonly oninput="persist()"></div>
      <div class="row"><button type="button" class="btn" onclick="sl_calcDOM()">Recalculate DOM</button></div>
      <div class="field"><label>Unit/Notes ID (optional)</label><input id="sl_unitid" type="text" placeholder="Buildium Unit # or WO #" oninput="persist()"></div>
    </div>
</div>
<div class="hr"></div>
<h3>Applications & Showings</h3>
<div class="two-col">
    <div class="soft">
      <div class="field"><label>New Apps</label><input id="sl_apps_new" type="number" min="0" value="0" oninput="persist()"></div>
      <div class="field"><label>Pending</label><input id="sl_apps_pending" type="number" min="0" value="0" oninput="persist()"></div>
      <div class="field"><label>Approved</label><input id="sl_apps_approved" type="number" min="0" value="0" oninput="persist()"></div>
      <div class="field"><label>Declined</label><input id="sl_apps_declined" type="number" min="0" value="0" oninput="persist()"></div>
    </div>
    <div class="soft">
      <div class="field"><label>Showings (last 7 days)</label><input id="sl_showings" type="number" min="0" value="0" oninput="persist()"></div>
      <div class="field"><label>Feedback (short)</label><input id="sl_feedback" type="text" placeholder="e.g., Price high / Needs photos" oninput="persist()"></div>
    </div>
</div>
<div class="hr"></div>
<div class="row">
    <a class="btn"
       id="sl_buildium"
       href="https://propertywize.managebuilding.com/manager/public/authentication/login?returnUrl=%2Fmanager%2Fapp%2Fdraft-leases%2Fdraft%2F101559%2Fsummary%3FopenSignModal%3Dtrue%26signatureRequestId%3D7cd1654a-b69c-4b35-ab4f-b1580df7a6df"
       target="_blank" rel="noopener">Open Buildium</a>
    <a class="btn"
       href="https://www.rentometer.com/"
       target="_blank" rel="noopener">Open Rentometer</a>
</div>
<div class="hr"></div>
<h3>Market Data</h3>
<div class="two-col">
    <div class="soft">
      <div class="field">
        <label>Median</label>
        <input id="sl_med" type="text" placeholder="$1,850" oninput="persist()">
      </div>
      <div class="field">
        <label>Range Low</label>
        <input id="sl_low" type="text" placeholder="$1,700" oninput="persist()">
      </div>
      <div class="field">
        <label>Range High</label>
        <input id="sl_high" type="text" placeholder="$2,050" oninput="persist()">
      </div>
    </div>
</div>
<div class="hr"></div>
<h3>Pre-Send Checklist</h3>
<details open>
    <summary><strong>Confirm before drafting</strong></summary>
    <div class="check"><input id="sl_ck_report" type="checkbox" onchange="persist()"><label for="sl_ck_report">Buildium Listing exported &amp; filtered</label></div>
    <div class="check"><input id="sl_ck_apps" type="checkbox" onchange="persist()"><label for="sl_ck_apps">Applications counts confirmed</label></div>
    <div class="check"><input id="sl_ck_rento" type="checkbox" onchange="persist()"><label for="sl_ck_rento">Rentometer PDF downloaded</label></div>
    <div class="check"><input id="sl_ck_epm" type="checkbox" onchange="persist()"><label for="sl_ck_epm">Sending to EPM for approval first</label></div>
</details>
<div class="hr"></div>
<h3>Outputs</h3>
<div class="row">
  <button type="button" class="btn primary" id="sl_btnGen" onclick="window.sl_generate()">Generate Owner Report</button>
  <button type="button" class="btn" id="sl_btnCopy" onclick="window.sl_copy('sl_out')">Copy Email Body</button>
</div>
<div class="row" style="margin-top:6px;">
  <button type="button" class="btn" id="sl_btnTxt" onclick="window.sl_downloadTXT()">Download Report (.txt)</button>
  <button type="button" class="btn" id="sl_btnCsv" onclick="window.sl_downloadCSV()">Download Summary (.csv)</button>
  <button type="button" class="btn" id="sl_btnEml" onclick="window.sl_downloadEML()">Download EPM Draft (.eml)</button>
   <button type="button" class="btn" id="sl_btnDom" onclick="window.sl_calcDOM()">Recalculate DOM</button>
</div>
  <div class="field">
    <label>Owner Report / Email Body</label>
    <textarea id="sl_out" readonly style="min-height:200px"></textarea>
  </div>
  <div class="hr"></div>
  <h3>Handoff</h3>
  <div class="row">
    <button type="button" class="btn" onclick="sl_copy('sl_handoff')">Copy Handoff Comment</button>
  </div>
  <div class="field">
    <textarea id="sl_handoff" readonly></textarea>
  </div>
</div> <!-- closes #viewListings -->
<!-- ==== /Stale Listing VIEW ==== -->
<!-- Plans Modal -->
<div id="plansModal" class="modal-overlay hidden">
  <div class="modal-box" style="max-width:680px;width:100%">
    <h3>Manage Owner Plans</h3>
    <p class="note">Edit to match your <b>exact plan titles</b>. One per line. This list powers the Owner Plan dropdown.</p>
    <textarea id="plansText" style="min-height:180px"></textarea>
    <div class="modal-actions" style="margin-top:8px">
      <button class="btn" onclick="closePlans()">Cancel</button>
      <button class="btn primary" onclick="savePlans()">Save Plans</button>
    </div>
  </div>
</div>                                          
<footer class="wrap" style="text-align:center;font-size:12px;color:var(--muted);padding-bottom:28px">
  ¬© 2025 PropertyWize ‚Ä¢ This single file runs entirely on your device. Add to Home Screen for faster access.
</footer>

<!-- MODAL HTML FOR ALERT/CONFIRM -->
<div id="pwModal" class="modal-overlay hidden">
  <div class="modal-box">
    <p id="pwModalText">Modal message goes here.</p>
    <div class="modal-actions">
      <button class="btn" id="pwModalCancel">Cancel</button>
      <button class="btn primary" id="pwModalOK">OK</button>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';
  // ====== State & helpers ======
  const $ = (q,ctx=document)=>ctx.querySelector(q);
  const $$ = (q,ctx=document)=>Array.from(ctx.querySelectorAll(q));
  
  // --- START MODAL REPLACEMENT FOR ALERT/CONFIRM ---
  const modal = {
    overlay: $('#pwModal'),
    text: $('#pwModalText'),
    ok: $('#pwModalOK'),
    cancel: $('#pwModalCancel'),
    _resolve: null
  };
  
  function pwAlert(msg) {
    if (!modal.overlay || !modal.text || !modal.ok || !modal.cancel) {
      console.warn("Modal not found, using native alert:", msg);
      return alert(msg); // Fallback
    }
    modal.text.textContent = msg;
    modal.cancel.classList.add('hidden');
    modal.ok.textContent = 'OK';
    modal.overlay.classList.add('visible');
    
    return new Promise((resolve) => {
      modal._resolve = resolve;
    });
  }

  function pwConfirm(msg) {
    return new Promise((resolve) => {
      if (!modal.overlay || !modal.text || !modal.ok || !modal.cancel) {
        console.warn("Modal not found, using native confirm:", msg);
        resolve(confirm(msg)); // Fallback
        return;
      }
      modal.text.textContent = msg;
      modal.cancel.classList.remove('hidden');
      modal.ok.textContent = 'OK';
      modal.overlay.classList.add('visible');
      
      modal._resolve = resolve;
    });
  }
  // --- END MODAL REPLACEMENT ---

  const views = { 
    welcome: $("#viewWelcome"), 
    maintenance: $("#viewMaintenance"), 
    finance: $("#viewFinance"), 
    nonmaint: $("#viewNonMaint"),
    delinquency: $("#viewDelinquency"),
    listings: $("#viewListings"),
    appliance: $("#viewAppliance")
  };
  const pills = $$("#rolePicker .pill");
  let activeRole = null;

  // Plans
  const DEFAULT_PLANS = [
    "Standard- (Owner Approval >300+)",
    "Home Warranty",
    "Basic- (Owner Approval >150+)",
    "Opt-Out (Owner Managed)",
    "Emergency-Only (Auto Approved, EPM Approved, FYI to Owner)",
    
  ];
  function loadPlans() {
    let list = localStorage.getItem("pw_plans");
    let plans = [];
    if(list) {
      try { plans = JSON.parse(list); } catch(e) { plans = []; }
    }
    if(!plans || !plans.length) plans = DEFAULT_PLANS;
    const sel = $("#plan");
    if(sel) {
      const currentVal = sel.value; // preserve selection
      sel.innerHTML = '<option value="">Select plan‚Ä¶</option>' + plans.map(p=>`<option value="${p}">${p}</option>`).join('');
      sel.value = currentVal; // re-apply selection
    }
    return plans;
  }
  window.openPlans = function() {
    $("#plansText").value = loadPlans().join("\n");
    $("#plansModal").classList.remove("hidden");
    $("#plansModal").classList.add('visible'); // Use modal class
  }
  window.closePlans = function() { 
    $("#plansModal").classList.add("hidden"); 
    $("#plansModal").classList.remove('visible');
  }
  window.savePlans = function() {
    const lines = $("#plansText").value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    localStorage.setItem("pw_plans", JSON.stringify(lines));
    pwAlert('Plans saved ‚úÖ'); 
    loadPlans();
    closePlans();
  }

  // Role switching
  function setRole(role, targetId){
    if (!targetId) { // Fallback if no targetId, try to find by role
        targetId = views[role] ? views[role].id : 'viewWelcome';
    }
    activeRole = role;
    
    // Update pill appearance
    $$("#rolePicker label.pill").forEach(p=> {
        const input = p.querySelector('input[type="radio"]');
        p.classList.toggle("active", input && input.value === role);
    });
    
    // Show the correct pane
    Object.values(views).forEach(v=>v && v.classList.add("hidden"));
    const targetView = views[role] || $(`#${targetId}`);
    
    if(targetView) {
        targetView.classList.remove("hidden");
    } else {
        views.welcome && views.welcome.classList.remove("hidden");
    }
    
    localStorage.setItem('pw_last_pane', targetId); // Save the pane ID
    updateProgress();
    window.scrollTo(0,0);
    // sync finance WO fields from maintenance if present
    if (role === 'finance') {
        const wo = $("#wo") ? $("#wo").value : '';
        const addr = $("#addr") ? $("#addr").value : '';
        const vendor = $("#vendor") ? $("#vendor").value : '';
        const amount = $("#amount") ? $("#amount").value : '';
        
        if ($("#fin_wo")) $("#fin_wo").value = wo; 
        if ($("#fin_addr")) $("#fin_addr").value = addr; 
        if ($("#fin_vendor")) $("#fin_vendor").value = vendor;
        if ($("#fin_amount")) $("#fin_amount").value = amount;
    }
  }

  // Buttons
  async function resetForm(){ 
    if (!await pwConfirm("Are you sure you want to reset the form? This will clear all fields.")) return; 
    localStorage.removeItem("pw_state");
    $$("input[type=checkbox], input[type=radio]").forEach(c=>c.checked=false);
    $$("input[type=text], input[type=number], input[type=date], input[type=url]").forEach(i=>i.value="");
    $$("select").forEach(s=>s.selectedIndex=0);
    $$("textarea").forEach(t=>t.value="");
    $$(".pill.active").forEach(p=>p.classList.remove("active"));
    
    // Reset specific tools
    if(window.dlq_clear) window.dlq_clear();
    if(window.appl_clear) window.appl_clear();
    if(window.pwNM_clear) window.pwNM_clear();
    if(window.pw_clearWB) window.pw_clearWB();
    
    setRole(null, 'viewWelcome'); // Go back to welcome
    calcRules();
  }

  // Progress
  function updateProgress(){
    const activePane = $$('.view-pane:not(.hidden)')[0] || document;
    let checks = $$("input[type=checkbox]", activePane);
    if (checks.length === 0) checks = $$("input[type=checkbox]"); // fallback
    let total = checks.length || 1;
    let done = checks.filter(c=>c.checked).length;
    let pct = Math.round(100*done/total);
    if ($("#progressBar")) $("#progressBar").style.width = pct+"%";
    if ($("#progressNote")) $("#progressNote").textContent = pct+"% complete";
  }

  // Policy cues
  function calcRules(){
    const amtEl = $("#amount");
    const issueEl = $("#issue");
    const policyEl = $("#policy");
    if (!amtEl || !issueEl || !policyEl) return;

    const amt = parseFloat(amtEl.value||"0");
    const issue = issueEl.value;
    let msg = [];
    if(!isNaN(amt) && issue){
      if(issue==="Emergency") {
        if(amt>300) msg.push("Emergency > $300 ‚Üí FYI to Owner required (Maintenance sends). No prior approval needed.");
        else msg.push("Emergency ‚â§ $300 ‚Üí FYI recommended; follow emergency SOP.");
      } else if(issue==="Non-Emergency") {
        if(amt>300) msg.push("Non‚ÄëEmergency > $300 ‚Üí Owner Approval required BEFORE dispatch.");
        else msg.push("Non‚ÄëEmergency ‚â§ $300 ‚Üí Auto‚Äëapprove per plan.");
      } else if (issue === "Cosmetic / Upgrade") {
        msg.push("Cosmetic/Upgrade ‚Üí Requires owner authorization regardless of amount.");
      } else {
         msg.push("Issue type selected. Enter amount for specific rules.");
      }
    } else {
      msg.push("Enter Amount and select Issue Type to see rules.");
    }
    policyEl.innerHTML = msg.join("<br>");
  }
  window.calcRules = calcRules;

  // Persist state
  const ALL_INPUT_IDS = ["wo","addr","vendor","plan","issue","amount","chkPhotos","chkTenant","chkFYI","chkOwnerOK","chkVendorApproved","chkWOStatus","chkInvoiceWO","chkAllDocs","chkReady",
                 "fin_wo","fin_addr","fin_vendor","fin_amount","fin_date","fin_invwo","fin_approve","fin_photos","fin_tenant","fin_temp","fin_enter","fin_link","fin_sheet","fin_epm","fin_pay","fin_upload","fin_done",
                 "nm_record","nm_epm","nm_pay",
                "maint_tenant","maint_address","maint_owner_name","maint_vendor_visitdate","maint_tenant_complaint","maint_vendor_findings","maint_vendor_reco","maint_vendor_estimate","maint_portal_link",
                "mt_tenant_resp","mt_followup_suggested","mt_tempcheck","mt_optout","mt_lease_violation","mt_tenant_chargeback","mt_chargeback_amt","mt_forward_fin",
                "wb_memo_process","wb_notice_notes","wb_amount","wb_ptype","wb_unpaid","wb_avgok","wb_memo_pay",
                "ho_from_wb","ho_to_wb","ho_person_wb","ho_due_wb","ho_ref_wb","ho_tags_wb","ho_decision_wb","ho_threshold_wb","ho_summary_wb","ho_block_wb","ho_attach_wb","ho_notify_wb",
                "ho_from_nb","ho_to_nb","ho_person_nb","ho_due_nb","ho_ref_nb","ho_tags_nb","ho_summary_nb","ho_block_nb","ho_attach_nb","ho_notify_nb",
                "dlq_tenant","dlq_address","dlq_rent","dlq_util","dlq_misc","dlq_fees","dlq_total","dlq_lastpay","dlq_lastcomm","dlq_ftp","dlq_court","dlq_judgment","dlq_eviction","dlq_noevict_reason","dlq_leaseend","dlq_lastaction",
                "dlq_manager","dlq_voucher","dlq_rentportion","dlq_blocked","dlq_ror","dlq_email_to","dlq_email_cc","dlq_email_subj",
                "sl_address","sl_owner","sl_listed","sl_rent","sl_dom","sl_unitid","sl_apps_new","sl_apps_pending","sl_apps_approved","sl_apps_declined","sl_showings","sl_feedback","sl_med","sl_low","sl_high",
                "appl_wo","appl_address","appl_unit","appl_tenant","appl_type","appl_balance","appl_priority","appl_epm","appl_complaint","appl_troubleshoot","appl_brand","appl_model","appl_serial","appl_color","appl_age","appl_album","appl_info_source","appl_vendor","appl_vendor_reco","appl_sent_vendor","appl_vendor_reviewed","appl_opt1","appl_opt2","appl_verify_price","appl_opt3","appl_notes"];

  function persist(){
    const st = {};
    ALL_INPUT_IDS.forEach(id=>{
      const el = $("#"+id); if(!el) return;
      if(el.type==="checkbox") st[id]=el.checked;
      else if(el.type==="radio") { if(el.checked) st[el.name]=el.value; }
      else st[id]=el.value;
    });
    localStorage.setItem("pw_state", JSON.stringify(st));
    calcRules(); updateProgress();
  }
  window.persist = persist; // Make global for inline handlers

  function restore(){
    loadPlans(); // Load plans first
    const raw = localStorage.getItem("pw_state"); if(!raw) return;
    try { var st = JSON.parse(raw); } catch(e){ return; }
    Object.entries(st).forEach(([id,val])=>{
      const el = $("#"+id); if(!el) return;
      if(el.type==="checkbox") el.checked = !!val; else el.value = val;
    });
    
    // Restore radio groups
    $$('input[type="radio"][name]').forEach(r => {
      if (st[r.name] && r.value === st[r.name]) r.checked = true;
    });

    calcRules(); updateProgress();
  }

  // Note generators
  async function genHandoff(){ 
    const req = ["chkAllDocs","chkReady"];
    for(const id of req){ if(!$("#"+id).checked) return pwAlert("Complete all handoff checks first."); } 
    const dt = new Date().toLocaleString();
    const txt = `WO # ${$("#wo").value||"[####]"} READY FOR FINANCE ‚Äî ${$("#addr").value||"<Address>"} ‚Äî ${$("#vendor").value||"<Vendor>"}\n`
      + `Plan: ${$("#plan").value||"<Plan>"} ‚Äî Issue: ${$("#issue").value||"<Type>"} ‚Äî Amount: $${$("#amount").value||"0.00"}\n`
      + `Date/Time: ${dt}\n\n`
      + `Attached in WO:\n`
      + `‚Ä¢ Invoice WITH WO#\n`
      + `‚Ä¢ Owner decision: (Non‚Äëemergency > $300 = APPROVAL) OR (Emergency > $300 = FYI by Maintenance)\n`
      + `‚Ä¢ Before/After photos (timestamp + watermark)\n`
      + `‚Ä¢ Tenant completion confirmation\n\n`
      + `Status: READY FOR FINANCE ‚Äî Assigned to: FINANCE\n`
      + `Notes: `;
    $("#handoff").value = txt;
    $("#handoff").focus(); $("#handoff").select();
    await pwAlert("Handoff Note Generated\nNote created in textarea."); 
  }
  
  async function genFinance(){ 
    const dt = new Date().toLocaleDateString();
    const N = (id) => $(`#${id}`) && $(`#${id}`).checked ? "‚úî" : "‚úñ"; // Safe check
    const V = (id1, id2, fb) => ($(`#${id1}`) ? $(`#${id1}`).value : '') || ($(`#${id2}`) ? ($(`#${id2}`).value || '') : '') || fb; // Fixed nested $

    const txt = `FINANCE INTAKE ‚Äî WO # ${V("fin_wo","wo","[####]")} ‚Äî ${V("fin_addr","addr","<Address>")}\n`
      + `Vendor: ${V("fin_vendor","vendor","<Vendor>")} ‚Äî Amount: $${V("fin_amount","amount","0.00")}\n`
      + `Approval/FYI date: ${V("fin_date","",dt)}\n\n`
      + `Verification:\n`
      + `[${ N("fin_invwo") }] Invoice WITH WO#\n`
      + `[${ N("fin_approve") }] Owner Approval (> $300 non‚Äëemergency) or FYI (> $300 emergency)\n`
      + `[${ N("fin_photos") }] Before/After photos (timestamp + watermark)\n`
      + `[${ N("fin_tenant") }] Tenant completion confirmation\n`
      + `[${ N("fin_temp") }] Temp Check present if > $300\n\n`
      + `Buildium/Spreadsheet:\n`
      + `[${ N("fin_enter") }] Entered via WO ‚Üí Enter Bill\n`
      + `[${ N("fin_link") }] Bill linked to WO; vendor/property/expense OK\n`
      + `[${ N("fin_sheet") }] Added to Finance spreadsheet\n`
      + `[${ N("fin_epm") }] EPM Approval received\n`
      + `[${ N("fin_pay") }] Payment issued\n`
      + `[${ N("fin_upload") }] Paid invoice uploaded & shared with Owner\n`
      + `[${ N("fin_done") }] Spreadsheet updated; copy saved to Drive`;
    $("#fin_note").value = txt;
    $("#fin_note").focus(); $("#fin_note").select();
    await pwAlert("Finance Note Generated\nNote created in textarea."); 
  } 

  // --- Maintenance Note (simple) ---
  async function genMaintNote() { 
    const issue = $(`#issue`).value || '';
    const flags = [
        $(`#mt_tenant_resp`).checked ? 'Tenant responsibility confirmed.' : null,
        $(`#mt_followup_suggested`).checked ? 'Vendor suggested follow-up.' : null,
        $(`#mt_tempcheck`).checked ? 'Temp check / 2nd opinion required.' : null,
        $(`#mt_lease_violation`).checked ? 'Lease violation triggered.' : null,
        $(`#mt_tenant_chargeback`).checked ? `Tenant chargeback required (${$(`#mt_chargeback_amt`).value}).` : null,
        $(`#mt_forward_fin`).checked ? 'Forwarded to Finance.' : null
    ].filter(Boolean).join('\n');
    $(`#mt_note`).value = `MAINTENANCE UPDATE\nIssue Type: ${issue}\n${flags}`;
    await pwAlert("Maintenance Note Generated."); 
  }
  async function copyMaintNote() { 
      if (!$(`#mt_note`).value) {
          return pwAlert("Generate note first!"); 
      }
      $(`#mt_note`).select(); 
      try { 
        document.execCommand('copy'); 
        await pwAlert("Copied to clipboard ‚úÖ"); 
      } catch(e) {}
  }
  
  // ====== EXPOSE FUNCTIONS TO GLOBAL (window) FOR HTML on-click ======
  // This block makes sure the onclick="..." attributes in your HTML can find the functions.
  window.genFinance = genFinance;
  window.genHandoff = genHandoff;
  window.genMaintNote = genMaintNote;
  window.copyMaintNote = copyMaintNote;
  window.openPlans = openPlans;
  window.savePlans = savePlans;
  window.closePlans = closePlans;
  window.persist = persist;
  window.calcRules = calcRules;


  // Init
  document.addEventListener('DOMContentLoaded', function() {
    
    // --- **FIX**: MODAL BUTTON WIRING ---
    if (modal.ok) {
        modal.ok.addEventListener('click', () => {
          modal.overlay.classList.remove('visible');
          if (modal._resolve) {
            modal._resolve(true); // Resolve the promise as 'true' (OK)
            modal._resolve = null;
          }
        });
    }
    if (modal.cancel) {
        modal.cancel.addEventListener('click', () => {
          modal.overlay.classList.remove('visible');
          if (modal._resolve) {
            modal._resolve(false); // Resolve the promise as 'false' (Cancel)
            modal._resolve = null;
          }
        });
    }
    // --- END MODAL WIRING ---
    
    // --- **FIX**: BIND ALL EVENT LISTENERS HERE ---

    // Global Buttons
    $("#btnReset").addEventListener("click", resetForm);
    $("#btnPrint").addEventListener("click", ()=>window.print());
    $("#btnPlans").addEventListener("click", openPlans);

    // Role switching
    $("#rolePicker").addEventListener("change", e=>{
      const radio = $("#rolePicker input[name=role]:checked");
      if (!radio) return;
      const role = radio.value || null;
      const targetId = radio.dataset.target || null;
      setRole(role, targetId);
    });

    // --- Maintenance Dispatch Flow (intake) ---
    (function(){
      const flow = $('#maintDispatchFlow');
      if (!flow) return;
      const outWrap = $('#mdf_out_wrap');
      const outBox  = $('#mdf_out');
      const emergEmail = $('#emerg_email_wrap');
      
      const OUT = {
        OUT_EMER: "Please follow the Emergency Dispatch Policy:\nStep 1: Send an FYI to the EPM for approval.\nStep 2: Once the EPM approves, send an FYI to the property owner.",
        OUT_DELINQ: "Complete Delinquency SOP before dispatching.\n‚Ä¢ Follow delinquency checklist and handoff steps.",
        OUT_HW: "Proceed with scheduling via Home Warranty.\n‚Ä¢ Open warranty portal and follow HW process.",
        OUT_NOTIFY_OWNER: "Notify the rental owner of the request.\n‚Ä¢ Confirm if the owner will complete the work.\n‚Ä¢ Document plan and timeline.",
        OUT_RECALL: "Check for recall/warranty within 12 months.\n‚Ä¢ Review invoice for warranty coverage (roofing, water proofing, HVAC, carpet, etc.).\n‚Ä¢ Begin Recall SOP if applicable.",
        OUT_STANDARD: "Proceed with Standard Dispatch.\n‚Ä¢ Send owner FYI (auto-approve where applicable)."
      };
      
      flow.addEventListener('click', function(e){
        const btn = e.target.closest('button[data-next]');
        if (!btn) return;
        const next = btn.dataset.next;
        $$('.flowQ', flow).forEach(q => q.classList.add('hidden'));
        if (next.startsWith('OUT_')) {
          outWrap && outWrap.classList.remove('hidden');
          outBox && (outBox.value = OUT[next] || 'Unknown outcome');
          if (next === 'OUT_EMER') emergEmail && emergEmail.classList.remove('hidden');
          else emergEmail && emergEmail.classList.add('hidden');
        } else {
          const nextQ = $(`#${next}`, flow);
          if (nextQ) nextQ.classList.remove('hidden');
          outWrap && outWrap.classList.add('hidden');
          emergEmail && emergEmail.classList.add('hidden');
        }
      });
      $('#mdf_reset').addEventListener('click', function(){
        $$('.flowQ', flow).forEach(q => q.classList.add('hidden'));
        $('#q1', flow).classList.remove('hidden');
        outWrap && outWrap.classList.add('hidden');
        emergEmail && emergEmail.classList.add('hidden');
        outBox && (outBox.value = '');
      });
      $('#mdf_copy').addEventListener('click', function(){
        if (!outBox) return; outBox.select();
        try { document.execCommand('copy'); } catch (err) {}
        const btn = this; const oldTxt = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = oldTxt, 1500);
      });
    })();

    // --- Emergency Email Generators ---
    (function(){
      const $id = (id) => document.getElementById(id);
      const txt = (id) => ($id(id)?.value || '').trim();
      function buildEmergencyEmails() {
        const t = txt('med_tenant') || txt('maint_tenant') || '[Tenant Name]';
        const addr = txt('med_address') || txt('maint_address') || '[Property Address]';
        const visit = txt('med_visit') || txt('maint_vendor_visitdate') || 'TBD';
        const estRaw = txt('med_estimate') || txt('maint_vendor_estimate');
        const est = estRaw ? Number(estRaw) : null;
        const ten = txt('med_tenant_stmt') || txt('maint_tenant_complaint') || '[Tenant statement]';
        const find = txt('med_findings') || txt('maint_vendor_findings') || '[Vendor findings]';
        const reco = txt('med_reco') || txt('maint_vendor_reco') || '[Vendor recommendation]';
        const owner = txt('maint_owner_name') || '[Owner Name]';
        const epmSubj = `üîî EPM Approval Needed ‚Äì Emergency Maintenance Ticket [${t} / ${addr}]`;
        const epmBody = `Dear EPM Team,\n\nPlease review the emergency maintenance request below and provide your approval before we notify the property owner.\n\nTenant Name: ${t}\nUnit Address: ${addr}\n\nReported Issue (Tenant Complaint):\n‚Äú${ten}‚Äù\n\nVendor‚Äôs Diagnosis:\n‚Äú${find}‚Äù\n\nProposed Work:\n‚Äú${reco}‚Äù\n\nEstimated Cost:\n${est !== null ? `$${est.toFixed(2)}` : 'TBD'} (Vendor Estimate) + 10% Surcharge\nTotal: ${est !== null ? `$${(est*1.10).toFixed(2)}` : 'TBD'}\n\nVisit Date: ${visit}\n`;
        const ownSubj = `üö® Emergency Dispatch FYI ‚Äì ${t} / ${addr}`;
        const ownBody = `Dear ${owner},\n\nIn order to better service you and ensure timely updates, please click on the ‚ÄúView Request‚Äù green button to reply via your portal if you are viewing this message in an email form.\n\nYou have a new emergency maintenance request from PropertyWize that has been approved and dispatched for your information. Details are provided below:\n\nTenant Name: ${t}\nUnit Address: ${addr}\n\nBrief Description of Work Requested:\nThe tenant reported:\n‚Äú${ten}‚Äù\n\nVendor‚Äôs Diagnosis:\nOur service provider visited the property on ${visit} and found/reported:\n‚Äú${find}‚Äù\n\nProposed Work:\n‚Äú${reco}‚Äù\n\nQuoted Cost:\n${est !== null ? `$${est.toFixed(2)}` : 'TBD'} (Vendor Estimate) + 10% Surcharge\nTotal: ${est !== null ? `$${(est*1.10).toFixed(2)}` : 'TBD'}\n\nThis repair has been approved under the emergency dispatch policy to prevent further damage or safety risk.\nYou will receive updates once the work is completed and the invoice has been processed.`;
        if ($id('epm_subj')) $id('epm_subj').value = epmSubj;
        if ($id('epm_body')) $id('epm_body').value = epmBody;
        if ($id('own_subj')) $id('own_subj').value = ownSubj;
        if ($id('own_body')) $id('own_body').value = ownBody;
      }
      const genBtn = $id('med_generate');
      if (genBtn) genBtn.addEventListener('click', (e)=>{ e.preventDefault(); buildEmergencyEmails(); });
      $$('[data-copy]').forEach(btn => {
        btn.addEventListener('click', function(e) {
          const targetId = e.target.dataset.copy;
          const target = $(targetId);
          if (target) {
            target.select();
            try { document.execCommand('copy'); } catch (err) {}
            const oldTxt = e.target.textContent;
            e.target.textContent = 'Copied!';
            setTimeout(() => e.target.textContent = oldTxt, 1500);
          }
        });
      });
      const inputs = ['med_tenant','med_address','med_visit','med_estimate','med_tenant_stmt','med_findings','med_reco','maint_owner_name','maint_tenant','maint_address','maint_vendor_visitdate','maint_vendor_estimate','maint_tenant_complaint','maint_vendor_findings','maint_vendor_reco'];
      inputs.forEach(id => $id(id) && $id(id).addEventListener('input', buildEmergencyEmails));
      const issueSel = $('#issue');
      if (issueSel) {
          issueSel.addEventListener('change', (e) => {
              const wrap = $('#emerg_email_wrap'); if (!wrap) return;
              if (e.target.value === 'Emergency') {
                  wrap.classList.remove('hidden');
                  buildEmergencyEmails();
              } else {
                  wrap.classList.add('hidden');
              }
          });
      }
    })();

    // --- Water Bill Helpers ---
    (function(){
      const N = (v) => parseFloat(String(v||'').replace(/[^0-9.]/g,'')) || 0;
      window.pw_copyFrom = function(id) { 
        var el = $(`#${id}`); if(!el) return; el.select(); 
        try { document.execCommand('copy'); } catch (err) {}
        var btn = event.target; var t = btn.textContent;
        btn.textContent = 'Copied!'; setTimeout(()=>btn.textContent=t, 900);
      }
      window.pw_decideWB = function() {
        var amount = N($(`#wb_amount`).value), type=$(`#wb_ptype`).value, unpaid=$(`#wb_unpaid`).value, avgok=$(`#wb_avgok`).value;
        var out=$('#wb_decision'); if(!out) return;
        if(!(amount>0)) return out.innerHTML = 'Enter details...';
        if(amount<=200) return out.innerHTML = '<span>Decision: <strong>APPROVE ‚Äì Direct pay</strong> (‚â§ $200)</span>';
        if(unpaid==='yes') return out.innerHTML = '<span>Decision: <strong>HOLD / REJECT</strong> ‚Äì Unpaid balances exist</span>';
        var th=(type==='sfd')?300:350;
        if(amount>th) return out.innerHTML = '<span>Decision: <strong>ESCALATE to EPM</strong> ‚Äì Over threshold</span>';
        if(amount>200 && amount<=th && avgok==='yes') return out.innerHTML = '<span>Decision: <strong>APPROVE ‚Äì Finance may pay</strong> (within avg, no unpaid)</span>';
        return out.innerHTML = '<span>Decision: <strong>ESCALATE</strong> ‚Äì Not within 6-mo average</span>';
      }
      window.pw_resetWB = function() {
        if ($(`#wb_amount`)) $(`#wb_amount`).value=''; if ($(`#wb_ptype`)) $(`#wb_ptype`).value='sfd'; 
        if ($(`#wb_unpaid`)) $(`#wb_unpaid`).value='no'; if ($(`#wb_avgok`)) $(`#wb_avgok`).value='yes';
        if ($('#wb_decision')) $(`#wb_decision`).innerHTML='';
      }
      window.pw_genWB = async function() { 
          if (!['wb_c1','wb_c2','wb_c3','wb_c4','wb_c5','wb_c6'].every(id => $(`#${id}`)?.checked)) {
              return pwAlert('Please complete the checklist before generating the handoff.'); 
          }
          /* Handoff tool gen */ 
      }
      window.pw_clearWB = function() { /* Handoff tool clear */ }
    })();

    // --- Non-Maint Bill Helpers ---
    (function(){
      window.pwNM_copy = function(id) { 
          var el = $(`#${id}`); if(!el) return; el.select();
          try { document.execCommand('copy'); } catch(e) {}
      }
      window.pwNM_gen = async function() { 
          if (!['nb_c1','nb_c2','nb_c3','nb_c4','nb_c5'].every(id => $(`#${id}`)?.checked)) {
              return pwAlert('Please complete the checklist before generating.'); 
          }
          /* gen */ 
      }
      window.pwNM_clear = function() { /* clear */ }
    })();
    
    // --- Delinquency Helpers ---
    (function(){
      const N = (v) => parseFloat(String(v||'').replace(/[^0-9.]/g,'')) || 0;
      const F = (n) => (Math.round(n*100)/100).toFixed(2);
      const gv = (id) => $(`#${id}`)?.value || '';
      const chk = (id) => $(`#${id}`)?.checked;
      
      function recalcDlq(){
          const total = N(gv('dlq_rent')) + N(gv('dlq_util')) + N(gv('dlq_misc')) + N(gv('dlq_fees'));
          if($(`#dlq_total`)) $(`#dlq_total`).value = F(total);
      }
      $$('#dlq_rent, #dlq_util, #dlq_misc, #dlq_fees').forEach(el => el.addEventListener('input', recalcDlq));
      
      window.dlq_generate = async function() { 
          if (!['dlq_c1','dlq_c2','dlq_c3','dlq_c4','dlq_c5','dlq_c6'].every(chk)) {
              return pwAlert('Please complete the checklist before generating.'); 
          }
          const subj = `Delinquency Update ‚Äì ${gv('dlq_tenant')} (${gv('dlq_address')})`;
          const body = `
Manager Assigned: ${gv('dlq_manager')}
Voucher Tenant: ${gv('dlq_voucher')}
Tenant's vs HAP Rent Portion: ${gv('dlq_rentportion')}
1. Tenant's Name: ${gv('dlq_tenant')}
2. Address: ${gv('dlq_address')}
3. Balance: ${gv('dlq_total')}
4. Last Payment Received: ${gv('dlq_lastpay')}
5. Last Communication from Tenant: ${gv('dlq_lastcomm')}
6. FTP Date: ${gv('dlq_ftp')}
7. Court Outcome: ${gv('dlq_court')}
8. Judgment Ordered: ${gv('dlq_judgment')}
9. Eviction Date Scheduled: ${gv('dlq_eviction')}
10. Last Action Completed: ${gv('dlq_lastaction')}
11. If no eviction schedule was completed, please state the reason: ${gv('dlq_noevict_reason')}
12. Lease End Date: ${gv('dlq_leaseend')}
13. Tenant status in Buildium reflects collection status, meaning they are blocked from making partial payments online: ${gv('dlq_blocked')}
14. Eligible for ROR? ${gv('dlq_ror')}
          `.trim();
          if ($(`#dlq_email_subj`)) $(`#dlq_email_subj`).value = subj;
          if ($(`#dlq_email_body`)) $(`#dlq_email_body`).value = body;
      }
      window.dlq_copy = function(id) { 
          var el = $(`#${id}`); if(!el) return; el.select();
          try { document.execCommand('copy'); } catch(e) {}
      }
      window.dlq_clear = function() { 
          $$('#viewDelinquency input[type=text], #viewDelinquency select, #viewDelinquency textarea').forEach(el => {
              if (el.tagName === 'SELECT') el.selectedIndex = 0;
              else if (!el.readOnly) el.value = '';
          });
          $$('#viewDelinquency input[type=checkbox]').forEach(el => el.checked = false);
          recalcDlq();
      }
      const previewBtn = $(`#dlq_email_preview`);
      if (previewBtn) previewBtn.addEventListener('click', window.dlq_generate);
      const sendBtn = $(`#dlq_email_send`);
      if (sendBtn) sendBtn.addEventListener('click', function() {
          window.dlq_generate(); // fill first
          const to = $(`#dlq_email_to`).value;
          const cc = $(`#dlq_email_cc`).value;
          const subj = $(`#dlq_email_subj`).value;
          const body = $(`#dlq_email_body`).value.replace(/\n/g, '\r\n');
          if (!to) return pwAlert('Please enter a To: email address.'); 
          let mailto = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
          if (cc) mailto += `&cc=${encodeURIComponent(cc)}`;
          window.location.href = mailto;
      });
    })();

    // --- Stale Listing Helpers ---
    (function(){
      const N = (v) => parseFloat(String(v||'').replace(/[^0-9.]/g,'')) || 0;
      const gv = (id) => $(`#${id}`)?.value || '';
      const gi = (id) => parseInt(gv(id), 10) || 0;
      const m$ = (x) => x && x[0]==='$' ? x : (x?('$'+x):'‚Äî');
      const today = () => new Date().toISOString().slice(0,10);
      const fmt = (d) => {
          if(!d) return '‚Äî';
          const t = new Date(d + 'T12:00:00Z'); // treat as UTC date
          return isNaN(t) ? d : `${t.getUTCMonth()+1}/${t.getUTCDate()}/${t.getUTCFullYear()}`;
      }
      
      window.sl_calcDOM = function() {
          const d = gv('sl_listed'); if(!d) return $(`#sl_dom`).value = '';
          const dt = new Date(d + 'T12:00:00Z');
          if(isNaN(dt)) return $(`#sl_dom`).value = '';
          const today = new Date();
          const todayUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
          const days = Math.max(0, Math.floor((todayUTC - dt) / 86400000));
          $(`#sl_dom`).value = days;
      }
      
      window.sl_generate = function() {
          sl_calcDOM();
          const addr=gv('sl_address')||'[Address]', owner=gv('sl_owner')||'Owner', listed=fmt(gv('sl_listed')), rent=m$(gv('sl_rent')), dom=gv('sl_dom')||'0';
          const aNew=gi('sl_apps_new'), aPen=gi('sl_apps_pending'), aApp=gi('sl_apps_approved'), aDec=gi('sl_apps_declined');
          const show=gi('sl_showings'), feed=gv('sl_feedback')||'‚Äî';
          const med=m$(gv('sl_med')), low=m$(gv('sl_low')), high=m$(gv('sl_high'));
          const reco = 'Based on this, we recommend...'; // Static recommendation
          const subj = `[PropertyWize] Unit Status ‚Äî ${addr} ‚Äî ${dom} days on market`;
          const body = `Hi ${owner},\n\nWe're reaching out to provide you with this week's update on the applications received for your property at ${addr}. Below is a summary of the activities from the past 7 days:\n\nListing Summary\n‚Ä¢ Date Listed: ${listed}\n‚Ä¢ List Rent: ${rent}\n‚Ä¢ DOM: ${dom}\n\nApplications\n‚Ä¢ New: ${aNew} | Pending: ${aPen} | Approved: ${aApp} | Declined: ${aDec}\n\nShowings/Feedback\n‚Ä¢ Showings in last 7 days: ${show}\n‚Ä¢ Feedback: "${feed}"\n\nMarket Check (Rentometer)\n‚Ä¢ Median: ${med} | Range: ${low}‚Äì${high}\n‚Ä¢ Current List: ${rent}\n\nRecommendation\n${reco}\n\nAttached: Buildium Listing + Rentometer Report\n\nThanks,\nPropertyWize Leasing Team`;
          $(`#sl_out`).value = `Subject: ${subj}\n\n${body}`;
          const stale = ((aApp===0 && dom>=14) || dom>=30) ? 'STALE' : 'MONITOR';
          $(`#sl_handoff`).value = `Stale Listing Review ‚Äî ${addr}\nDOM: ${dom} | List: ${rent}\nApps N/P/A/D: ${aNew}/${aPen}/${aApp}/${aDec} | Showings(7d): ${show}\nRentometer: med ${med}, range ${low}-${high}\nReco: ${reco}\nStatus: ${stale}\nEPM approval required before owner send.`;
      }
      
      const dl = (name, mime, txt) => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([txt], {type: `${mime};charset=utf-8`}));
          a.download = name;
          a.click();
          setTimeout(() => URL.revokeObjectURL(a.href), 1000);
      }
      
      window.sl_copy = (id) => { 
          var el = $(`#${id}`); if(!el) return;
          el.select(); 
          try { document.execCommand('copy'); } catch(e) {}
      }
      window.sl_downloadTXT = () => { if(!gv('sl_out')) sl_generate(); dl(`OwnerReport_${gv('sl_address')}_${today()}.txt`, 'text/plain', gv('sl_out')); }
      window.sl_downloadCSV = () => {
          const csv = `Date,Address,ListRent,DOM,New,Pending,Approved,Declined,Showings7d,Median,Low,High\n` +
                      `${today()},"${gv('sl_address')}","${gv('sl_rent')}",${gv('sl_dom')},${gi('sl_apps_new')},${gi('sl_apps_pending')},${gi('sl_apps_approved')},${gi('sl_apps_declined')},${gi('sl_showings')},"${gv('sl_med')}","${gv('sl_low')}","${gv('sl_high')}"`;
          dl(`StaleListing_${gv('sl_address')}_${today()}.csv`, 'text/csv', csv);
      }
      window.sl_downloadEML = () => {
          if(!gv('sl_out')) sl_generate();
          const body = gv('sl_out').replace(/Subject:.*\n\n/, '');
          const subj = `EPM Review ‚Äì ${gv('sl_address')} ‚Äì ${gv('sl_dom')} DOM`;
          const eml = `From: \nTo: operationsmgr@propertywize.com\nSubject: ${subj}\nContent-Type: text/plain; charset=UTF-8\n\n${body}`;
          dl(`EPM_Review_${gv('sl_address')}_${today()}.eml`, 'message/rfc822', eml);
      }
      
      const slListed = $('#sl_listed');
      if(slListed) slListed.addEventListener('change', sl_calcDOM);
    })();
    
    // --- Appliance Helpers ---
    (function(){
      const N = (v) => parseFloat(String(v||'').replace(/[^0-9.]/g,'')) || 0;
      const gv = (id) => $(`#${id}`)?.value || '';
      const chk = (id) => $(`#${id}`)?.checked;
      
      window.appl_insertTroubleshooting = () => {
          const ta = $(`#appl_troubleshoot`);
          if (ta && !ta.value) ta.value = "1) Power/Breaker checked and ON\n2) Model/Serial recorded\n3) Photos captured (add Drive link)\n4) Refrigerator: temps/coils/seals\n5) Dryer: lint/vent airflow checked";
      }
      
      window.appl_generate = async function() { 
          if (!['appl_ck_delinquency','appl_ck_ack','appl_ck_details','appl_ck_vendor','appl_ck_options','appl_ck_photos'].every(chk)) {
              return pwAlert('Please complete the checklist first.'); 
          }
          const balance = N(gv('appl_balance'));
          const type = gv('appl_type').toLowerCase();
          const priority = gv('appl_priority');
          const essential = (priority === 'essential') || (!priority && (type.includes('refrigerator') || type.includes('oven') || type.includes('range') || type.includes('stove')));
          
          if (balance > 500 && !essential) {
              $(`#appl_email_out`).value = 'Email generation blocked: Tenant is delinquent ($'+balance+') and appliance is non-essential.';
              $(`#appl_deferral`).value = `Dear ${gv('appl_tenant')},\n\nThank you for your request. We are unable to process this non-essential appliance ticket as your account is not in good standing (Balance: $${balance}). Please contact Collections to make arrangements.\n\nOnce your account is current, please resubmit your request.\n\nThanks,\nPropertyWize Management`;
              await pwAlert('Email generation blocked: Tenant is delinquent ($'+balance+') and appliance is non-essential.'); 
              return;
          }
          const epmBody = `
EPM ‚Äì Appliance Ticket ${gv('appl_wo')}
Address: ${gv('appl_address')}, ${gv('appl_unit')}
Appliance: ${gv('appl_type')} / ${gv('appl_brand')} / ${gv('appl_color')}
S/N: ${gv('appl_serial')} | Age: ${gv('appl_age')}
Issue: ${gv('appl_complaint')}
Priority: ${essential ? 'Essential' : 'Non-Essential'}
Album: ${gv('appl_album')}
Vendor: ${gv('appl_vendor')} | Reco: ${gv('appl_vendor_reco')} | Reviewed: ${chk('appl_vendor_reviewed')}
---
Option 1 (NEW): ${gv('appl_opt1')}
Option 2 (NEW): ${gv('appl_opt2')}
Option 3 (USED): ${gv('appl_opt3')}
Notes: ${gv('appl_notes')}
          `.trim();
          $(`#appl_email_out`).value = epmBody;
          $(`#appl_handoff`).value = `WO ${gv('appl_wo')} ${gv('appl_type')} ‚Äì ${gv('appl_vendor_reco')} | Issue: ${gv('appl_complaint')} | Vendor: ${gv('appl_vendor')} | ${chk('appl_vendor_reviewed')?'Reviewed':'Pending'}`;
          $(`#appl_deferral`).value = ''; // Clear deferral
          await pwAlert('EPM Email and Handoff Note have been generated.'); 
      }
      
      window.appl_copy = (id) => { 
          var el = $(`#${id}`); if(!el) return;
          el.select(); 
          try { document.execCommand('copy'); } catch(e) {}
      }
      window.appl_clear = () => {
          $$('#viewAppliance input[type=text], #viewAppliance input[type=date], #viewAppliance input[type=url], #viewAppliance input[type=number], #viewAppliance textarea').forEach(i=> { if(!i.readOnly) i.value=''; });
          $$('#viewAppliance select').forEach(s=>s.selectedIndex=0);
          $$('#viewAppliance input[type=checkbox]').forEach(c=>c.checked=false);
      }
    })();
    
    // --- Global listeners ---
    document.addEventListener("change", e=>{
      if(e.target.matches("input[type=checkbox]")) updateProgress();
    });

    // --- **FIX**: MODAL BUTTON WIRING ---
    if (modal.ok) {
        modal.ok.addEventListener('click', () => {
          modal.overlay.classList.remove('visible');
          if (modal._resolve) {
            modal._resolve(true); // Resolve the promise as 'true' (OK)
            modal._resolve = null;
          }
        });
    }
    if (modal.cancel) {
        modal.cancel.addEventListener('click', () => {
          modal.overlay.classList.remove('visible');
          if (modal._resolve) {
            modal._resolve(false); // Resolve the promise as 'false' (Cancel)
            modal._resolve = null;
          }
        });
    }
    // --- END MODAL WIRING ---
    
    // --- Restore state and set initial view ---
    restore(); 
    const lastPane = localStorage.getItem('pw_last_pane') || 'viewWelcome';
    const radio = $(`#rolePicker input[data-target="${lastPane}"]`);
    if (radio) {
        radio.checked = true;
        setRole(radio.value, lastPane);
    } else {
        setRole(null, 'viewWelcome'); // Start at welcome
    }

  }); // --- END OF DOMCONTENTLOADED ---
  
  // ====== EXPOSE FUNCTIONS TO GLOBAL (window) FOR HTML on-click ======
  // This block is fine outside DOMContentLoaded because it just assigns functions
  window.genFinance = genFinance;
  window.genHandoff = genHandoff;
  window.genMaintNote = genMaintNote;
  window.copyMaintNote = copyMaintNote;
  window.dlq_generate = dlq_generate;
  window.dlq_copy = dlq_copy;
  window.dlq_clear = dlq_clear;
  window.dlq_send = dlq_send;
  window.sl_generate = sl_generate;
  window.sl_copy = sl_copy;
  window.sl_calcDOM = sl_calcDOM;
  window.sl_downloadTXT = sl_downloadTXT;
  window.sl_downloadCSV = sl_downloadCSV;
  window.sl_downloadEML = sl_downloadEML;
  window.appl_generate = appl_generate;
  window.appl_insertTroubleshooting = appl_insertTroubleshooting;
  window.appl_copy = appl_copy;
  window.appl_clear = appl_clear;
  window.openPlans = openPlans;
  window.savePlans = savePlans;
  window.closePlans = closePlans;
  window.pw_decideWB = pw_decideWB;
  window.pw_resetWB = pw_resetWB;
  window.pw_genWB = pw_genWB;
  window.pw_clearWB = pw_clearWB;
  window.pw_copyFrom = pw_copyFrom;
  window.pwNM_gen = pwNM_gen;
  window.pwNM_copy = pwNM_copy;
  window.pwNM_clear = pwNM_clear;
  window.persist = persist;
  window.calcRules = calcRules;

})();
</script>
</body>
</html>

